<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head th:replace="tienda/framer/head :: head(${pageTitle})"></head>

  <body>
    <div class="site">
      <div th:replace="tienda/framer/header :: siteHeaderMobile"></div>
      <div th:replace="tienda/framer/header :: siteHeader"></div>

      <div class="site__body">
        <div
          class="block-header block-header--has-breadcrumb block-header--has-title"
        >
          <div class="container">
            <div class="block-header__body">
              <nav
                class="breadcrumb block-header__breadcrumb"
                aria-label="breadcrumb"
              >
                <ol class="breadcrumb__list">
                  <li
                    class="breadcrumb__spaceship-safe-area"
                    role="presentation"
                  ></li>
                  <li
                    class="breadcrumb__item breadcrumb__item--parent breadcrumb__item--first"
                  >
                    <a href="index.html" class="breadcrumb__item-link"
                      >Inicio</a
                    >
                  </li>
                  <li class="breadcrumb__item breadcrumb__item--parent">
                    <a href="#" class="breadcrumb__item-link">Carrito</a>
                  </li>
                  <li
                    class="breadcrumb__item breadcrumb__item--current breadcrumb__item--last"
                    aria-current="page"
                  >
                    <span class="breadcrumb__item-link">Pagar</span>
                  </li>
                  <li
                    class="breadcrumb__title-safe-area"
                    role="presentation"
                  ></li>
                </ol>
              </nav>
              <h1 class="block-header__title">Finalizar compra</h1>
            </div>
          </div>
        </div>

        <div class="checkout block">
          <div class="container container--max--xl">
            <div class="row">
              <div class="col-12 mb-3" th:if="${clienteSesion == null}">
                <div class="alert alert-lg alert-primary">
                  ¿Ya tienes cuenta?
                  <a href="/home/perfil">Haz clic aquí para iniciar sesión</a>
                </div>
              </div>

              <!-- Datos de facturación -->
              <div class="col-12 col-lg-6 col-xl-7">
                <div class="card mb-lg-0">
                  <div class="card-body card-body--padding--2">
                    <h3 class="card-title">Detalles de facturación</h3>

                    <div class="form-row">
                      <div class="form-group col-md-6">
                        <label for="checkout-first-name">Nombre</label>
                        <input
                          type="text"
                          class="form-control"
                          id="checkout-first-name"
                          placeholder="Nombre"
                          th:value="${persona != null ? persona.nombres : ''}"
                        />
                      </div>

                      <div class="form-group col-md-6">
                        <label for="checkout-last-name">Apellido</label>
                        <input
                          type="text"
                          class="form-control"
                          id="checkout-last-name"
                          placeholder="Apellido"
                          th:value="${persona != null ? persona.apellidos : ''}"
                        />
                      </div>
                    </div>

                    <div class="form-row">
                      <div class="form-group col-md-6">
                        <label for="checkout-document"
                          >Documento (DNI / RUC)</label
                        >
                        <input
                          type="text"
                          class="form-control"
                          id="checkout-document"
                          placeholder="DNI o RUC"
                          th:value="${persona != null ? persona.numeroDocumento : ''}"
                        />
                      </div>
                      <div class="form-group col-md-6">
                        <label for="checkout-street-address">Dirección</label>
                        <input
                          type="text"
                          class="form-control"
                          id="checkout-street-address"
                          placeholder="Dirección"
                          th:value="${persona != null ? persona.direccion : ''}"
                        />
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group col-md-4">
                        <label for="checkout-city">Ciudad</label>
                        <input
                          type="text"
                          class="form-control"
                          id="checkout-city"
                          th:value="${persona != null ? persona.ciudad : ''}"
                        />
                      </div>

                      <div class="form-group col-md-4">
                        <label for="checkout-state">Provincia / Región</label>
                        <input
                          type="text"
                          class="form-control"
                          id="checkout-state"
                          th:value="${persona != null ? persona.provincia : ''}"
                        />
                      </div>

                      <div class="form-group col-md-4">
                        <label for="checkout-postcode">Código Postal</label>
                        <input
                          type="text"
                          class="form-control"
                          id="checkout-postcode"
                          th:value="${persona != null ? persona.codigoPostal : ''}"
                        />
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group col-md-6">
                        <label for="checkout-email">Correo electrónico</label>
                        <input
                          type="email"
                          class="form-control"
                          id="checkout-email"
                          placeholder="Correo electrónico"
                          th:value="${persona != null ? persona.email : ''}"
                        />
                      </div>
                      <div class="form-group col-md-6">
                        <label for="checkout-phone">Teléfono</label>
                        <input
                          type="text"
                          class="form-control"
                          id="checkout-phone"
                          placeholder="Teléfono"
                          th:value="${persona != null ? persona.telefono : ''}"
                        />
                      </div>
                    </div>

                    <div class="form-group" th:if="${clienteSesion == null}">
                      <div class="form-check">
                        <span class="input-check form-check-input">
                          <span class="input-check__body">
                            <input
                              class="input-check__input"
                              type="checkbox"
                              id="checkout-create-account"
                            />
                            <span class="input-check__box"></span>
                            <span class="input-check__icon">
                              <svg width="9px" height="7px">
                                <path
                                  d="M9,1.395L3.46,7L0,3.5L1.383,2.095L3.46,4.2L7.617,0L9,1.395Z"
                                />
                              </svg>
                            </span>
                          </span>
                        </span>
                        <label
                          class="form-check-label"
                          for="checkout-create-account"
                          >¿Crear una cuenta?</label
                        >
                      </div>
                    </div>
                  </div>

                  <div class="card-divider"></div>

                  <!-- Envío -->
                  <div class="card-body card-body--padding--2">
                    <h3 class="card-title">Detalles de envío</h3>

                    <div class="form-group">
                      <div class="form-check">
                        <span class="input-check form-check-input">
                          <span class="input-check__body">
                            <input
                              class="input-check__input"
                              type="checkbox"
                              id="checkout-different-address"
                            />
                            <span class="input-check__box"></span>
                            <span class="input-check__icon">
                              <svg width="9px" height="7px">
                                <path
                                  d="M9,1.395L3.46,7L0,3.5L1.383,2.095L3.46,4.2L7.617,0L9,1.395Z"
                                />
                              </svg>
                            </span>
                          </span>
                        </span>
                        <label
                          class="form-check-label"
                          for="checkout-different-address"
                          >¿Enviar a una dirección diferente?</label
                        >
                      </div>
                    </div>

                    <div class="form-group">
                      <label for="checkout-comment"
                        >Notas del pedido
                        <span class="text-muted">(Opcional)</span></label
                      >
                      <textarea
                        id="checkout-comment"
                        class="form-control"
                        rows="4"
                      ></textarea>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Resumen del pedido -->
              <div class="col-12 col-lg-6 col-xl-5 mt-4 mt-lg-0">
                <div class="card mb-0">
                  <div class="card-body card-body--padding--2">
                    <h3 class="card-title">Tu pedido</h3>

                    <table class="checkout__totals">
                      <thead class="checkout__totals-header">
                        <tr>
                          <th>Producto</th>
                          <th>Total</th>
                        </tr>
                      </thead>

                      <tbody
                        class="checkout__totals-products"
                        id="checkout-products"
                      ></tbody>

                      <tbody class="checkout__totals-subtotals">
                        <tr>
                          <th>Subtotal</th>
                          <td id="checkout-subtotal">S/. 0.00</td>
                        </tr>
                        <tr>
                          <th>Envío</th>
                          <td id="checkout-envio">S/. 0.00</td>
                        </tr>
                      </tbody>

                      <tfoot class="checkout__totals-footer">
                        <tr>
                          <th>Total</th>
                          <td id="checkout-total">S/. 0.00</td>
                        </tr>
                      </tfoot>
                    </table>

                    <!-- Métodos de pago -->
                    <div class="checkout__payment-methods payment-methods">
                      <ul class="payment-methods__list">
                        <li
                          class="payment-methods__item payment-methods__item--active"
                        >
                          <label class="payment-methods__item-header">
                            <form
                              id="payshop-form"
                              action="https://pay.doolpool.com/checkout/create"
                              method="post"
                              style="width: 100%"
                            >
                              <input type="hidden" name="mode" value="" />
                              <input type="hidden" name="public_key" value="" />
                              <input type="hidden" name="order_id" value="" />
                              <input type="hidden" name="amount" value="" />
                              <input type="hidden" name="currency" value="" />
                              <input type="hidden" name="timestamp" value="" />
                              <input type="hidden" name="nonce" value="" />
                              <input type="hidden" name="signature" value="" />
                              <input type="hidden" name="_redirect" value="1" />

                              <button
                                style="
                                  padding: 5px 10px;
                                  background: white;
                                  width: 100%;
                                "
                                type="button"
                                onclick="onPayShopClick(event)"
                              >
                                Pagar con PayShop
                              </button>
                            </form>
                          </label>
                          <div class="payment-methods__item-container">
                            <div
                              class="payment-methods__item-details text-muted"
                            >
                              Realiza el pago con PayShop, unas vez contenplado
                              confirmaremos su compra.
                            </div>
                          </div>
                        </li>
                      </ul>
                    </div>
                    <div class="checkout__agree form-group">
                      <div class="form-check">
                        <span class="input-check form-check-input">
                          <span class="input-check__body">
                            <input
                              class="input-check__input"
                              type="checkbox"
                              id="checkout-terms"
                            />
                            <span class="input-check__box"></span>
                            <span class="input-check__icon">
                              <svg width="9px" height="7px">
                                <path
                                  d="M9,1.395L3.46,7L0,3.5L1.383,2.095L3.46,4.2L7.617,0L9,1.395Z"
                                />
                              </svg>
                            </span>
                          </span>
                        </span>
                        <label class="form-check-label" for="checkout-terms">
                          He leído y acepto los
                          <a target="_blank" href="terms.html"
                            >términos y condiciones</a
                          ></label
                        >
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="block-space block-space--layout--before-footer"></div>
      </div>

      <div th:replace="tienda/framer/footer :: siteFooter"></div>
    </div>
    <div th:replace="tienda/framer/scripts :: scripts"></div>

    <script th:inline="javascript">
      function getCartItems() {
        try {
          const raw = localStorage.getItem("cartItems");
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
          console.error("Error leyendo carrito en checkout:", e);
          return [];
        }
      }

      function renderCheckoutTable() {
        const items = getCartItems();
        const tbody = document.getElementById("checkout-products");
        const subtotalEl = document.getElementById("checkout-subtotal");
        const envioEl = document.getElementById("checkout-envio");
        const totalEl = document.getElementById("checkout-total");

        if (!tbody) return;

        tbody.innerHTML = "";
        let subtotal = 0;

        items.forEach((item) => {
          const totalItem = (item.precio || 0) * (item.cantidad || 0);
          subtotal += totalItem;

          const tr = document.createElement("tr");
          tr.innerHTML = `
              <td>${item.nombre} × ${item.cantidad}</td>
              <td>S/. ${totalItem.toFixed(2)}</td>
          `;
          tbody.appendChild(tr);
        });

        const envio = subtotal * 0.05;
        const total = subtotal + envio;

        subtotalEl.textContent = "S/. " + subtotal.toFixed(2);
        envioEl.textContent = "S/. " + envio.toFixed(2);
        totalEl.textContent = "S/. " + total.toFixed(2);
      }


async function onPayShopClick(event) {
        console.log("onPayShopClick");
        event.preventDefault();

        const terms = document.getElementById("checkout-terms");

        if (!terms) {
          alert("Error: no se encontró el checkbox de términos.");
          return;
        }

      const payload = {
          nombres: document.getElementById('checkout-first-name').value.trim(),
          apellidos: document.getElementById('checkout-last-name').value.trim(),
          empresa: (document.getElementById('checkout-company-name')?.value || '').trim(),
          direccion: document.getElementById('checkout-street-address').value.trim(),
          direccion2: (document.getElementById('checkout-address')?.value || '').trim(),
          ciudad: document.getElementById('checkout-city').value.trim(),
          provincia: document.getElementById('checkout-state').value.trim(),
          codigoPostal: document.getElementById('checkout-postcode').value.trim(),
          email: document.getElementById('checkout-email').value.trim(),
          telefono: document.getElementById('checkout-phone').value.trim(),
          comentario: (document.getElementById('checkout-comment')?.value || '').trim(),
          crearCuenta: (document.getElementById('checkout-create-account')?.checked) || false,
          documento: document.getElementById('checkout-document').value.trim(),
          // MAPEAR bien el id del carrito -> productoId para el backend
          items: items.map(i => ({
              productoId: parseInt(i.id, 10),
              nombre: i.nombre,
              precio: i.precio,
              cantidad: i.cantidad
          }))
      };

try {
    //console.log('Payload prepare:', payload);
    const resp = await fetch('/api/tienda/checkout/prepare', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    });

    const text = await resp.text();   // <-- leemos texto crudo primero
    console.log('prepare status:', resp.status);
    console.log('prepare body:', text);

    if (!resp.ok) {
        alert('Ocurrió un error preparando el pago. Código: ' + resp.status);
        return;
    }

    let data;
    try {
        data = JSON.parse(text);
    } catch (e) {
        console.error('No se pudo parsear JSON:', e);
        alert('El servidor no devolvió un JSON válido.');
        return;
    }

    const form = document.getElementById('payshop-form');

    if (!form) {
        alert('No se encontró el formulario de PayShop.');
        return;
    }

    Object.entries(data.params).forEach(([key, value]) => {
        let input = form.querySelector(`input[name="${key}"]`);
        if (!input) {
            input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            form.appendChild(input);
        }

        if (!terms.checked) {
          alert("Debes aceptar los términos y condiciones.");
          return;
        }

        const items = getCartItems();
        if (!items.length) {
          alert("Tu carrito está vacío.");
          return;
        }

        const payload = {
          nombres: document.getElementById("checkout-first-name").value.trim(),
          apellidos: document.getElementById("checkout-last-name").value.trim(),
          empresa: (
            document.getElementById("checkout-company-name")?.value || ""
          ).trim(),
          direccion: document
            .getElementById("checkout-street-address")
            .value.trim(),
          direccion2: (
            document.getElementById("checkout-address")?.value || ""
          ).trim(),
          ciudad: document.getElementById("checkout-city").value.trim(),
          provincia: document.getElementById("checkout-state").value.trim(),
          codigoPostal: document
            .getElementById("checkout-postcode")
            .value.trim(),
          email: document.getElementById("checkout-email").value.trim(),
          telefono: document.getElementById("checkout-phone").value.trim(),
          comentario: (
            document.getElementById("checkout-comment")?.value || ""
          ).trim(),
          crearCuenta:
            document.getElementById("checkout-create-account")?.checked ||
            false,

          documento: document.getElementById("checkout-document").value.trim(),
          // MAPEAR bien el id del carrito -> productoId para el backend
          items: items.map((i) => ({
            productoId: parseInt(i.id, 10),
            nombre: i.nombre,
            precio: i.precio,
            cantidad: i.cantidad,
          }))
        };

        try {
          console.log("Payload prepare:", payload);
          const resp = await fetch("/api/tienda/checkout/prepare", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          const text = await resp.text(); // <-- leemos texto crudo primero
          console.log("prepare status:", resp.status);
          console.log("prepare body:", text);

          if (!resp.ok) {
            alert(
              "Ocurrió un error preparando el pago. Código: " + resp.status
            );
            return;
          }

          let data;
          try {
            data = JSON.parse(text);
          } catch (e) {
            console.error("No se pudo parsear JSON:", e);
            alert("El servidor no devolvió un JSON válido.");
            return;
          }

          const form = document.getElementById("payshop-form");

          if (!form) {
            alert("No se encontró el formulario de PayShop.");
            return;
          }

          Object.entries(data.params).forEach(([key, value]) => {
            let input = form.querySelector(`input[name="${key}"]`);
            if (!input) {
              input = document.createElement("input");
              input.type = "hidden";
              input.name = key;
              form.appendChild(input);
            }
            input.value = value;
          });

          form.submit();
        } catch (e) {
          console.error("Error en fetch prepare:", e);
          alert("No se pudo conectar con el servidor para preparar el pago.");
        }

      }


  } catch (e) {
      console.error("Error en fetch prepare:", e);
      alert("Error preparando el pago.");
  }
}
      document.addEventListener("DOMContentLoaded", function () {
        renderCheckoutTable();
      });
    </script>

  </body>
</html>
