<div class="pc-container" th:replace="~{dashboard/layout :: layout(~{::content}, ${usuario}, 'Inicio', '/dashboard')}">
   <div class="pc-content" th:fragment="content">
      <!-- [ Main Content ] start -->

      <div class="page-header">
         <div class="page-block">
            <div class="row align-items-center">
               <div class="col-md-12">
                  <div class="page-header-title">
                     <h5 class="m-b-10">Productos Online</h5>
                  </div>
                  <ul class="breadcrumb">
                     <li class="breadcrumb-item"><a href="../index.html">Logística</a></li>
                     <li class="breadcrumb-item"><a href="#!">Almacen</a></li>
                     <li class="breadcrumb-item" aria-current="page">Productos Online</li>
                  </ul>
               </div>
            </div>
         </div>
      </div>
      <div class="row">
         <div class="col-12">
            <div class="card table-card">
               <div class="card-header d-flex align-items-center justify-content-between">
                  <h5 class="mb-0">Gestión de Tienda Online</h5>






                  <div class="d-flex" hidden>

                     <select class="form-select me-2" style="width: 200px;" hidden>
                        <option value="">Todas las categorías</option>
                        <option value="motor">Motor</option>
                        <option value="transmision">Transmisión</option>
                        <option value="diesel">Diésel</option>
                     </select>
                     <select class="form-select" style="width: 200px;" hidden>
                        <option value="">Todos los estados</option>
                        <option value="publicado">Publicados</option>
                        <option value="oculto">Ocultos</option>
                     </select>
                  </div>

                  <!--MODAL DE GESTION DE PRODUCTOS ONLINE-->
                  <div id="exampleModalLive" class="modal fade" tabindex="-1" role="dialog"
                     aria-labelledby="exampleModalLiveLabel" aria-hidden="true">

                     <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                        <div class="modal-content">

                           <div class="modal-header">
                              <h5 class="modal-title" id="exampleModalLiveLabel">Publicar Producto en Tienda
                                 Online
                              </h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"
                                 aria-label="Close"></button>
                           </div>

                           <div class="modal-body">
                              <div class="row">

                                 <div class="col-md-5" style="border-right: 1px solid #ddd;">

                                    <div class="mb-3">
                                       <label for="buscarProducto" class="form-label">1. Buscar Producto</label>
                                       <input type="text" class="form-control" id="buscarProducto"
                                          placeholder="Buscar por SKU o Nombre...">
                                    </div>

                                    <div class="list-group" style="max-height: 400px; overflow-y: auto;">


                                    </div>
                                 </div>

                                 <div class="col-md-7">
                                    <h6 class="mb-3">2. Configurar para la Tienda</h6>

                                    <form>
                                       <div class="mb-3">
                                          <label for="onlinePrecio" class="form-label">Precio Online (S/)</label>
                                          <input type="number" class="form-control" id="onlinePrecio"
                                             placeholder="95.90">
                                          <small class="form-text text-muted">Deja en blanco para usar el precio
                                             estándar (S/ 95.90).</small>
                                       </div>

                                       <div class="mb-3">
                                          <label for="onlineDesc" class="form-label">Descripción para la
                                             Tienda</label>
                                          <textarea class="form-control" id="onlineDesc" rows="5"
                                             placeholder="Añade una descripción detallada..."></textarea>
                                       </div>

                                       <div class="mb-3">
                                          <label class="form-label">Galería de Imágenes</label>
                                          <input class="form-control" type="file" id="onlineImagenes" multiple>
                                          <small class="form-text text-muted">Puedes subir múltiples imágenes para
                                             la
                                             galería.</small>
                                       </div>

                                       <div class="mb-3">
                                          <label class="form-label">Opciones de Publicación</label>
                                          <div class="form-check form-switch">
                                             <input class="form-check-input" type="checkbox" role="switch"
                                                id="onlineVisible" checked>
                                             <label class="form-check-label" for="onlineVisible">Publicar en la
                                                tienda online</label>
                                          </div>
                                          <div class="form-check form-switch">
                                             <input class="form-check-input" type="checkbox" role="switch"
                                                id="onlineDestacado">
                                             <label class="form-check-label" for="onlineDestacado">Marcar como
                                                producto destacado</label>
                                          </div>
                                       </div>
                                    </form>
                                 </div>

                              </div>
                           </div>

                           <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                                 onclick="LimpiarModal()">Cancelar</button>
                              <button type="button" class="btn btn-primary" onclick="publicarProducto()">Publicar
                                 Producto</button>

                           </div>

                        </div>
                     </div>
                  </div>
                  <!--FIN MODAL DE GESTION DE PRODUCTOS ONLINE-->

                  <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                     data-bs-target="#exampleModalLive" onclick="LimpiarModal()">
                     <i class="ti ti-plus me-1"></i> Publicar Nuevo Producto
                  </button>




               </div>
               <div class="card-body">
                  <div class="table-responsive">
                     <table class="table table-hover align-middle">
                        <thead class="table-light">
                           <tr>
                              <th>Imagen</th>
                              <th>Producto</th>
                              <th>Precio Online</th>
                              <th>Visible</th>
                              <th>Destacado</th>
                              <th>Acciones</th>
                           </tr>
                        </thead>
                        <tbody id="tablaProductosOnline"></tbody>
                     </table>
                  </div>
               </div>
            </div>
         </div>
      </div>


      <div class="modal fade" id="modalOnlineSettings" tabindex="-1" aria-labelledby="modalOnlineSettingsLabel"
         aria-hidden="true">
         <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
               <div class="modal-header">
                  <h5 class="modal-title" id="modalOnlineSettingsLabel">Ajustes Online: Castrol GTX 20W-50</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
               </div>
               <div class="modal-body">
                  <form>
                     <div class="row">
                        <div class="col-md-7">
                           <div class="mb-3">
                              <label for="onlinePrecio" class="form-label">Precio Online (S/)</label>
                              <input type="number" class="form-control" id="onlinePrecio" placeholder="95.90">
                              <small class="form-text text-muted">Deja en blanco para usar el precio de venta
                                 estándar.</small>
                           </div>

                           <div class="mb-3">
                              <label for="onlineDesc" class="form-label">Descripción para la Tienda Online</label>
                              <textarea class="form-control" id="onlineDesc" rows="5"
                                 placeholder="Añade una descripción detallada para el cliente..."></textarea>
                           </div>

                           <div class="mb-3">
                              <label class="form-label">Visibilidad</label>
                              <div class="form-check form-switch">
                                 <input class="form-check-input" type="checkbox" role="switch" id="onlineVisible"
                                    checked>
                                 <label class="form-check-label" for="onlineVisible">Publicar en la tienda
                                    online</label>
                              </div>
                           </div>

                           <div class="mb-3">
                              <label class="form-label">Destacado</label>
                              <div class="form-check form-switch">
                                 <input class="form-check-input" type="checkbox" role="switch" id="onlineDestacado">
                                 <label class="form-check-label" for="onlineDestacado">Marcar como producto destacado
                                    (Página de inicio)</label>
                              </div>
                           </div>

                        </div>

                        <div class="col-md-5">
                           <label class="form-label">Galería de Imágenes</label>
                           <div class="mb-2">
                              <img src="/assets/images/user/avatar-1.jpg" alt="preview" class="img-fluid rounded"
                                 style="border: 1px solid #ddd; padding: 5px;">
                           </div>
                           <div class="d-flex">
                              <img src="/assets/images/user/avatar-1.jpg" alt="thumb" class="img-fluid rounded me-2"
                                 style="width: 60px; height: 60px; border: 2px solid #007bff; padding: 2px; cursor: pointer;">
                              <img src="/assets/images/user/avatar-1.jpg" alt="thumb" class="img-fluid rounded me-2"
                                 style="width: 60px; height: 60px; border: 1px solid #ddd; padding: 2px; cursor: pointer;">
                              <div class="d-flex align-items-center justify-content-center rounded"
                                 style="width: 60px; height: 60px; border: 1px dashed #ddd; cursor: pointer;">
                                 <i class="ti ti-plus text-muted"></i>
                              </div>
                           </div>
                           <div class="mt-3">
                              <label for="onlineImagenes" class="form-label">Añadir más imágenes</label>
                              <input class="form-control" type="file" id="onlineImagenes" multiple>
                           </div>
                        </div>
                     </div>
                  </form>
               </div>
               <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                     onclick="LimpiarModal()">Cancelar</button>
                  <button type="button" class="btn btn-primary">Guardar Cambios</button>
               </div>
            </div>
         </div>
      </div>


      <!-- [ Main Content ] end -->
   </div>
</div>


<script>
   document.addEventListener("DOMContentLoaded", () => {

      function LimpiarModal() {
         const buscarInput = document.getElementById("buscarProducto");
         const precioInput = document.getElementById("onlinePrecio");
         const descInput = document.getElementById("onlineDesc");
         const visibleCheck = document.getElementById("onlineVisible");
         const destacadoCheck = document.getElementById("onlineDestacado");
         const imagenInput = document.getElementById("onlineImagenes");
         const form = document.querySelector("#exampleModalLive .modal-body form");
         const modalTitle = document.getElementById("exampleModalLiveLabel");
         const listaProductos = document.querySelector(".list-group");

         listaProductos.innerHTML = `<p class="text-muted px-3">escribe para buscar...</p>`;

         if (buscarInput) {
            buscarInput.disabled = false;
            buscarInput.value = "";
            delete buscarInput.dataset.idProducto;
         }
         if (precioInput) precioInput.value = "";
         if (descInput) descInput.value = "";

         if (visibleCheck) visibleCheck.checked = true;
         if (destacadoCheck) destacadoCheck.checked = false;

         if (imagenInput) imagenInput.value = "";

         if (modalTitle) modalTitle.innerText = "Publicar Producto en Tienda Online";

         if (form) {
            form.querySelectorAll(".invalid-feedback").forEach(e => e.remove());
            form.querySelectorAll(".is-invalid").forEach(e => e.classList.remove("is-invalid"));
         }

         const alerta = document.getElementById("alertaOnline");
         if (alerta) alerta.remove();

         const btnGuardar = document.querySelector("#exampleModalLive .modal-footer button.btn-primary");
         if (btnGuardar) {
            btnGuardar.textContent = "Publicar Producto";
            btnGuardar.onclick = window.publicarProducto;
         }
      }

      const buscarInput = document.getElementById("buscarProducto");
      const listaProductos = document.querySelector(".list-group");
      const modalElement = document.getElementById("exampleModalLive");
      const modal = new bootstrap.Modal(modalElement);
      const tablaBody = document.getElementById("tablaProductosOnline");
      const btnGuardar = modalElement.querySelector("button.btn-primary");

      modalElement.addEventListener("hidden.bs.modal", () => {
         LimpiarModal();
      });

      let debounceTimeout;
      buscarInput.addEventListener("input", () => {
         clearTimeout(debounceTimeout);
         debounceTimeout = setTimeout(buscarProductos, 400);
      });

      async function buscarProductos() {
         const query = buscarInput.value.trim();
         if (query.length < 2) {
            listaProductos.innerHTML = `<p class="text-muted px-3">Escribe al menos 2 caracteres...</p>`;
            return;
         }

         listaProductos.innerHTML = `<p class="text-primary px-3">Buscando...</p>`;
         try {
            const response = await fetch(`/api/productos/buscar?query=${encodeURIComponent(query)}`);
            if (!response.ok) throw new Error("Error al obtener productos");
            const productos = await response.json();

            listaProductos.innerHTML = productos.length
               ? productos.map(p => `
         <a href="#" class="list-group-item list-group-item-action d-flex align-items-center"
            onclick="seleccionarProducto(${p.idProducto}, '${escapeHtml(p.nombre)}', '${escapeHtml(p.codigo)}')">
           <img src="/assets/images/user/avatar-1.jpg" alt="Producto" class="img-fluid rounded me-3" style="width: 40px; height: 40px;">
           <div>
             <h6 class="mb-0">${p.nombre}</h6>
             <small class="text-muted d-block">SKU: ${p.codigo}</small>
           </div>
         </a>`).join("")
               : `<p class="text-muted px-3">No se encontraron productos.</p>`;
         } catch (err) {
            console.error(err);
            listaProductos.innerHTML = `<p class="text-danger px-3">Error al buscar productos.</p>`;
         }
      }

      window.seleccionarProducto = function (id, nombre, codigo) {
         document.getElementById("exampleModalLiveLabel").innerText = `Publicar Producto: ${nombre}`;
         buscarInput.value = `${nombre} (${codigo})`;
         buscarInput.dataset.idProducto = id;
      };

      window.publicarProducto = async function () {
         limpiarErrores();

         const idProducto = buscarInput.dataset.idProducto;
         const precioInput = document.getElementById("onlinePrecio");
         const descInput = document.getElementById("onlineDesc");
         const imagenInput = document.getElementById("onlineImagenes");

         const precio = parseFloat(precioInput.value);
         const descripcion = descInput.value.trim();
         const publicado = document.getElementById("onlineVisible").checked;
         const destacado = document.getElementById("onlineDestacado").checked;

         let valido = true;
         if (!idProducto) { mostrarError("buscarProducto", "Debe seleccionar un producto antes de publicar."); valido = false; }
         if (isNaN(precio) || precio <= 0) { mostrarError("onlinePrecio", "El precio online debe ser mayor que 0."); valido = false; }
         if (descripcion.length < 10) { mostrarError("onlineDesc", "La descripción debe tener al menos 10 caracteres."); valido = false; }
         if (!valido) return;

         const data = { idProducto, precioOnline: precio, descripcion, imagenes: null, publicado, destacado };

         try {
            mostrarMensajeExito("Publicando producto...");
            const response = await fetch(`/api/productos-online`, {
               method: "POST",
               headers: { "Content-Type": "application/json" },
               body: JSON.stringify(data)
            });
            if (!response.ok) throw new Error(await response.text());
            mostrarMensajeExito("Producto publicado correctamente.");
            await cargarProductosOnline();

            setTimeout(() => {
               modal.hide();
               LimpiarModal();
            }, 800);

         } catch (err) {
            mostrarMensajeError("Error al publicar: " + err.message);
         }
      };

      async function cargarProductosOnline() {
         try {
            const response = await fetch("/api/productos-online");
            if (!response.ok) throw new Error("Error al cargar productos");
            const productos = await response.json();

            tablaBody.innerHTML = productos.length ? productos.map(p => `
       <tr>
         <td><img src="${p.imagenPrincipal || '/assets/images/user/avatar-1.jpg'}" class="rounded" style="width: 50px; height: 50px;"></td>
         <td><strong>${escapeHtml(p.producto.nombre)}</strong><br><small class="text-muted">SKU: ${escapeHtml(p.producto.codigo)}</small></td>
         <td>S/ ${p.precioOnline.toFixed(2)}</td>
         <td>${p.publicado ? '<span class="badge bg-success">Sí</span>' : '<span class="badge bg-secondary">No</span>'}</td>
         <td>${p.destacado ? '<span class="badge bg-warning text-dark">Sí</span>' : '<span class="badge bg-secondary">No</span>'}</td>
         <td>
           <button class="btn btn-sm btn-outline-primary me-1" onclick="editarProductoOnline(${p.idProductoOnline})"><i class="ti ti-edit"></i></button>
           <button class="btn btn-sm btn-outline-danger" onclick="eliminarProductoOnline(${p.idProductoOnline})"><i class="ti ti-trash"></i></button>
         </td>
       </tr>`).join("") : `<tr><td colspan="6" class="text-center text-muted py-3">No hay productos publicados.</td></tr>`;
         } catch (err) {
            console.error(err);
            alert("Error al listar productos online: " + err.message);
         }
      }
      cargarProductosOnline();

      window.editarProductoOnline = async function (id) {
         try {
            const response = await fetch(`/api/productos-online/${id}`);
            if (!response.ok) throw new Error("No se encontró el producto");
            const producto = await response.json();

            document.getElementById("exampleModalLiveLabel").innerText = `Editar Producto: ${producto.producto.nombre}`;
            buscarInput.disabled = true;

            buscarInput.value = `${producto.producto.nombre} (${producto.producto.codigo})`;
            buscarInput.dataset.idProducto = producto.producto.idProducto;
            document.getElementById("onlinePrecio").value = producto.precioOnline;
            document.getElementById("onlineDesc").value = producto.descripcion;
            document.getElementById("onlineVisible").checked = producto.publicado;
            document.getElementById("onlineDestacado").checked = producto.destacado;
            const listaProductos = document.querySelector(".list-group");
            listaProductos.innerHTML = `
            <a href="#" class="list-group-item list-group-item-action d-flex align-items-center"
            onclick="seleccionarProducto(${producto.producto.idProducto}, '${escapeHtml(producto.producto.nombre)}', '${escapeHtml(producto.producto.codigo)}')">
           <img src="/assets/images/user/avatar-1.jpg" alt="Producto" class="img-fluid rounded me-3" style="width: 40px; height: 40px;">
           <div>
             <h6 class="mb-0">${producto.producto.nombre}</h6>
             <small class="text-muted d-block">SKU: ${producto.producto.codigo}</small>
           </div>
         </a>`;

            modal.show();

            const btn = document.querySelector("#exampleModalLive .modal-footer button.btn-primary");
            if (btn) {
               btn.textContent = "Actualizar";
               btn.onclick = () => actualizarProductoOnline(id);
            }
         } catch (err) {
            alert("Error al editar: " + err.message);
         }
      };

      async function actualizarProductoOnline(id) {
         const precio = parseFloat(document.getElementById("onlinePrecio").value);
         const descripcion = document.getElementById("onlineDesc").value.trim();
         const publicado = document.getElementById("onlineVisible").checked;
         const destacado = document.getElementById("onlineDestacado").checked;

         let valido = true;
         if (isNaN(precio) || precio <= 0) { mostrarError("onlinePrecio", "El precio online debe ser mayor que 0."); valido = false; }
         if (descripcion.length < 10) { mostrarError("onlineDesc", "La descripción debe tener al menos 10 caracteres."); valido = false; }
         if (!valido) return;

         const data = {
            idProducto: buscarInput.dataset.idProducto,
            precioOnline: precio,
            descripcion,
            publicado,
            destacado
         };

         try {
            const response = await fetch(`/api/productos-online/${id}`, {
               method: "PUT",
               headers: { "Content-Type": "application/json" },
               body: JSON.stringify(data)
            });
            if (!response.ok) throw new Error(await response.text());
            mostrarMensajeExito("Producto actualizado correctamente.");
            await cargarProductosOnline();

            setTimeout(() => {
               modal.hide();
               LimpiarModal();
            }, 800);
         } catch (err) {
            alert("Error al actualizar: " + err.message);
         }
      }

      window.eliminarProductoOnline = async function (id) {
         if (!confirm("¿Seguro que deseas eliminar este producto online?")) return;
         try {
            const response = await fetch(`/api/productos-online/${id}`, { method: "DELETE" });
            if (!response.ok) throw new Error(await response.text());
            alert("Producto eliminado correctamente.");
            cargarProductosOnline();
         } catch (err) {
            alert("Error al eliminar: " + err.message);
         }
      };

      function mostrarError(idCampo, mensaje) {
         const campo = document.getElementById(idCampo);
         if (!campo) return;
         campo.classList.add("is-invalid");
         const small = document.createElement("div");
         small.classList.add("invalid-feedback");
         small.textContent = mensaje;
         campo.parentNode.appendChild(small);
         campo.addEventListener("input", () => {
            campo.classList.remove("is-invalid");
            small.remove();
         }, { once: true });
      }

      function limpiarErrores() {
         document.querySelectorAll(".invalid-feedback").forEach(el => el.remove());
         document.querySelectorAll(".is-invalid").forEach(el => el.classList.remove("is-invalid"));
      }

      function mostrarMensajeExito(msg) { mostrarAlertaGlobal(msg, "success"); }
      function mostrarMensajeError(msg) { mostrarAlertaGlobal(msg, "danger"); }

      function mostrarAlertaGlobal(msg, tipo) {
         let alerta = document.getElementById("alertaOnline");
         const form = document.querySelector("#exampleModalLive .modal-body form");
         if (!alerta) {
            alerta = document.createElement("div");
            alerta.id = "alertaOnline";
            if (form) form.prepend(alerta);
         }
         alerta.className = `alert alert-${tipo} mt-3`;
         alerta.textContent = msg;
         setTimeout(() => alerta.remove(), 4000);
      }

      function escapeHtml(text) {
         return String(text).replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" }[m]));
      }

   });
</script>