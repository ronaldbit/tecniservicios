<div class="pc-container" th:replace="~{dashboard/layout :: layout(~{::content}, ${usuario}, 'Inicio', '/dashboard')}">
   <div class="pc-content" th:fragment="content">
      <div class="pc-content">
         <div class="page-header">
            <div class="page-block">
               <div class="row align-items-center">
                  <div class="col-md-12">
                     <div class="page-header-title">
                        <h5 class="m-b-10">Categorías de Productos</h5>
                     </div>
                     <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="../index.html">Logística</a></li>
                        <li class="breadcrumb-item"><a href="#!">Almacen</a></li>
                        <li class="breadcrumb-item" aria-current="page">Categorías</li>
                     </ul>
                  </div>
               </div>
            </div>
         </div>
         <div class="row">
            <div class="col-12">
               <div class="card table-card">
                  <div class="card-header d-flex align-items-center justify-content-between">
                     <h5 class="mb-0">Listado de Categorías</h5>
                     <div class="btn-page">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                           data-bs-target="#modalCategoria">
                           <i class="ti ti-plus me-1"></i> Nueva Categoría
                        </button>
                     </div>
                  </div>
                  <div class="card-body pt-3">
                     <div class="table-responsive">
                        <table class="table table-hover" id="pc-dt-simple">
                           <thead>
                              <tr>
                                 <th>Nombre de Categoría</th>
                                 <th>Descripción</th>
                                 <th>N° de Productos</th>
                                 <th>Estado</th>
                                 <th>Acciones</th>
                              </tr>
                           </thead>
                           <tbody>


                           </tbody>
                        </table>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>


      <div class="modal fade" id="modalCategoria" tabindex="-1" aria-labelledby="modalCategoriaLabel"
         aria-hidden="true">
         <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
               <div class="modal-header">
                  <h5 class="modal-title" id="modalCategoriaLabel">Añadir/Editar Categoría</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
               </div>
               <div class="modal-body">
                  <div id="alertMessage" class="alert alert-danger d-none" role="alert"></div>

                  <form id="categoriaForm">
                     <div class="mb-3">
                        <label for="catNombre" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="catNombre" placeholder="Ej: Motor" required>
                     </div>

                     <div class="mb-3">
                        <label for="catDescripcion" class="form-label">Descripción (Opcional)</label>
                        <textarea class="form-control" id="catDescripcion" rows="3"
                           placeholder="Ej: Aceites y lubricantes para motor."></textarea>
                     </div>

                     <div class="mb-3" hidden>
                        <label class="form-label">Estado</label>
                        <div class="form-check form-switch">
                           <input class="form-check-input" type="checkbox" role="switch" id="catEstado" checked>
                           <label class="form-check-label" for="catEstado">Activa</label>
                        </div>
                     </div>
                  </form>
               </div>

               <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="submit" form="categoriaForm" class="btn btn-primary">Guardar Cambios</button>
               </div>
            </div>
         </div>
      </div>
      <!-- [ Main Content ] end -->
   </div>
</div>

<th:block th:fragment="js">

   <script>
      document.addEventListener('DOMContentLoaded', () => {

         const modalElement = document.getElementById('modalCategoria');
         const modalInstance = new bootstrap.Modal(modalElement);
         const modalForm = document.getElementById('categoriaForm');
         const alertMessage = document.getElementById('alertMessage');
         const modalTitle = modalElement.querySelector('.modal-title');
         const tableBody = document.querySelector('#pc-dt-simple tbody');
         const btnNuevaCategoria = document.querySelector('button[data-bs-target="#modalCategoria"]');

         const showAlert = (message) => {
            alertMessage.textContent = message;
            alertMessage.classList.remove('d-none');
         };

         const hideAlert = () => {
            alertMessage.textContent = '';
            alertMessage.classList.add('d-none');
         };

         const renderEstado = (estado) => {
            switch (estado) {
               case 'ACTIVO':
                  return '<span class="badge text-bg-success">Activo</span>';
               case 'INACTIVO':
                  return '<span class="badge text-bg-secondary">Inactivo</span>';
               case 'ELIMINADO':
                  return '<span class="badge text-bg-danger">Eliminado</span>';
               default:
                  return `<span class="badge text-bg-warning">${estado}</span>`;
            }
         };

         const resetModal = () => {
            modalForm.reset();
            modalTitle.textContent = 'Añadir Categoría';
            modalElement._id = null;
            modalForm.querySelector('#catEstado').checked = true;
            hideAlert(); 
         };

         const cargarCategorias = async () => {
            try {
               const response = await fetch('/api/categorias');
               if (!response.ok) throw new Error('Error al cargar datos');
               const categorias = await response.json();

               tableBody.innerHTML = '';

               categorias.forEach(cat => {
                  const tr = document.createElement('tr');
                  const catDataString = JSON.stringify(cat).replace(/'/g, "&apos;");

                  tr.innerHTML = `
                     <td><h6 class="mb-0">${cat.nombre}</h6></td>
                     <td>${cat.descripcion || ''}</td>
                     <td>0</td>
                     <td>${renderEstado(cat.estado)}</td>
                     <td>
                     <a href="#" class="avtar avtar-xs btn-link-secondary btn-edit" 
                     title="Editar" 
                     data-id="${cat.idCategoria}" 
                     data-categoria='${catDataString}'>
                        <i class="ti ti-edit f-20"></i>
                     </a>
                     <a href="#" class="avtar avtar-xs btn-link-secondary btn-delete" 
                     title="Eliminar"
                     data-id="${cat.idCategoria}">
                     <i class="ti ti-trash f-20"></i>
                     </a>
                     </td>
                     `;
                  tableBody.appendChild(tr);
               });
            } catch (error) {
               console.error('Error en cargarCategorias:', error);
               tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error al cargar datos.</td></tr>`;
            }
         };
         btnNuevaCategoria.addEventListener('click', () => {
            resetModal();
         });

         tableBody.addEventListener('click', (e) => {
            e.preventDefault();
            const btnEdit = e.target.closest('.btn-edit');
            const btnDelete = e.target.closest('.btn-delete');

            if (btnEdit) {
               const catData = JSON.parse(btnEdit.dataset.categoria);
               resetModal();
               modalTitle.textContent = 'Editar Categoría';
               modalElement._id = catData.idCategoria;
               modalForm.querySelector('#catNombre').value = catData.nombre;
               modalForm.querySelector('#catDescripcion').value = catData.descripcion;
               modalForm.querySelector('#catEstado').checked = (catData.estado === 'ACTIVO');
               modalInstance.show();

            } else if (btnDelete) {
               const id = btnDelete.dataset.id;
               if (confirm('¿Está seguro de que desea eliminar esta categoría?')) {
                  fetch(`/api/categorias/${id}`, { method: 'DELETE' })
                     .then(response => {
                        if (!response.ok) throw new Error('Error al eliminar');
                        cargarCategorias();
                     })
                     .catch(error => {
                        console.error('Error al eliminar:', error)
                        alert('No se pudo eliminar la categoría.');
                     });
               }
            }
         });
         modalForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            hideAlert();
            const id = modalElement._id;
            const url = id ? `/api/categorias/${id}` : '/api/categorias';
            const method = id ? 'PUT' : 'POST';
            const data = {
               nombre: modalForm.querySelector('#catNombre').value,
               descripcion: modalForm.querySelector('#catDescripcion').value
            };

            try {
               const response = await fetch(url, {
                  method: method,
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(data)
               });

               if (!response.ok) {
                  let errorMsg = 'Error al guardar';
                  try {
                     const errorData = await response.text();
                     errorMsg = errorData.message || JSON.stringify(errorData);
                  } catch (e) {
                     errorMsg = await response.text();
                  }
                  throw new Error(errorMsg);
               }

               modalInstance.hide();
               cargarCategorias();

            } catch (error) {
               console.error('Error al guardar:', error);
               showAlert('Error al guardar: ' + error.message);
            }
         });
         cargarCategorias();
      });
   </script>
</th:block>