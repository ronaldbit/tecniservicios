<div class="pc-container" th:replace="~{dashboard/layout :: layout(~{::content}, ${usuario}, 'Inicio', '/dashboard')}">
   <div class="pc-content" th:fragment="content">
      <style>
         .swal2-container {
            z-index: 99999 !important;
         }
      </style>
      <div class="page-header">
      </div>

      <div class="row">
         <div class="col-12">
            <div class="card table-card">
               <div class="card-header d-flex align-items-center justify-content-between">
                  <h5 class="mb-0">Órdenes de Compra</h5>
                  <div class="btn-page">
                     <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                        data-bs-target="#modalNuevoPedido">
                        <i class="ti ti-plus me-1"></i> Nuevo Pedido
                     </button>
                  </div>
               </div>
               <div class="card-body pt-3">
                  <div class="table-responsive">
                     <table class="table table-hover" id="pc-dt-simple">
                        <thead>
                           <tr>
                              <th>ID Pedido</th>
                              <th>Proveedor</th>
                              <th>Fecha Emisión</th>
                              <th>Fecha Esperada</th>
                              <th>Costo Cotización</th>
                              <th>Estado</th>
                              <th>Acciones</th>
                           </tr>
                        </thead>
                        <tbody id="pedidosTbody">
                        </tbody>
                     </table>
                  </div>
               </div>
            </div>
         </div>
      </div>

      <div class="modal fade" id="modalNuevoPedido" tabindex="-1" aria-labelledby="modalNuevoPedidoLabel"
         aria-hidden="true">
         <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
               <div class="modal-header">
                  <h5 class="modal-title" id="modalNuevoPedidoLabel">Crear Pedido a Proveedor</h5> <button type="button"
                     class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
               </div>
               <div class="modal-body">
                  <form id="formNuevoPedido">
                     <div class="row">
                        <div class="col-md-6">
                           <div class="mb-3"> <label for="pedidoProveedor" class="form-label">Proveedor</label> <select
                                 class="form-select" id="pedidoProveedor" required>
                                 <option value="" selected disabled>Cargando proveedores...</option>
                              </select> </div>
                        </div>
                        <div class="col-md-3">
                           <div class="mb-3">
                              <label for="pedidoFecha" class="form-label">Fecha de Emisión</label>

                              <input type="date" class="form-control" id="pedidoFecha"
                                 th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}" readonly required>

                           </div>
                        </div>
                        <div class="col-12">
                           <div class="mb-3"> <label for="pedidoNotas" class="form-label">Notas</label> <textarea
                                 class="form-control" id="pedidoNotas" rows="2" placeholder="Notas internas"></textarea>
                           </div>
                        </div>
                     </div>
                     <hr class="my-3">
                     <div class="row">
                        <div class="col-12">
                           <h5>Añadir Productos</h5>
                           <div class="mb-3"> <label for="productoSearchInput" class="form-label">Buscar producto (por
                                 nombre o código)</label> <input type="text" class="form-control"
                                 id="productoSearchInput" placeholder="Escribe para buscar...">
                              <div id="productoSearchResults" class="list-group mt-1"
                                 style="max-height: 200px; overflow-y: auto;"></div>
                           </div>
                        </div>
                     </div>
                     <div class="table-responsive mt-3">
                        <table class="table table-sm">
                           <thead>
                              <tr>
                                 <th style="width: 40%;">Producto</th>
                                 <th style="width: 15%;">Stock actual</th>
                                 <th style="width: 15%;">Cantidad</th>
                                 <th></th>
                              </tr>
                           </thead>
                           <tbody id="tablaProductosPedido"> </tbody>
                        </table>
                     </div>
                  </form>
               </div>
               <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="button" class="btn btn-primary" id="btnGuardarPedido">Realizar Cotización</button>
               </div>
            </div>
         </div>
      </div>

      <div class="modal fade" id="modalVistaPrevia" tabindex="-1" aria-labelledby="modalVistaPreviaLabel"
         aria-hidden="true">
         <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
               <div class="modal-header">
                  <h5 class="modal-title" id="modalVistaPreviaLabel">Detalle del Pedido</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
               </div>
               <div class="modal-body">
                  <div class="row mb-3">
                     <div class="col-md-8">
                        <strong>Proveedor:</strong>
                        <p id="detalle-proveedor" class="mb-1 text-muted">Cargando...</p>
                        <strong>ID Pedido:</strong>
                        <p id="detalle-id" class="mb-0 text-muted">Cargando...</p>
                     </div>
                     <div class="col-md-4 text-md-end">
                        <strong>Estado:</strong>
                        <p id="detalle-estado" class="mb-1">Cargando...</p>
                        <strong>Total Cotización:</strong>
                        <h4 id="detalle-total" class="mb-0 text-primary">Cargando...</h4>
                     </div>
                  </div>

                  <div class="row mb-3">
                     <div class="col-md-4">
                        <strong>Fecha Emisión:</strong>
                        <p id="detalle-fecha-emision" class="mb-0 text-muted">Cargando...</p>
                     </div>
                     <div class="col-md-4">
                        <strong>Fecha Esperada:</strong>
                        <p id="detalle-fecha-esperada" class="mb-0 text-muted">Cargando...</p>
                     </div>
                     <div class="col-md-4">
                        <strong>Creado el:</strong>
                        <p id="detalle-fecha-creacion" class="mb-0 text-muted">Cargando...</p>
                     </div>
                  </div>
                  <div class="row mb-3">
                     <div class="col-12">
                        <strong>Notas:</strong>
                        <p id="detalle-notas" class="text-muted fst-italic">Cargando...</p>
                     </div>
                  </div>

                  <hr>
                  <h6 class="mb-3">Productos Incluidos</h6>

                  <div class="table-responsive">
                     <table class="table table-sm">
                        <thead>
                           <tr>
                              <th>Producto</th>
                              <th>Cantidad</th>
                              <th>Estado Entrega</th>
                           </tr>
                        </thead>
                        <tbody id="detalle-tabla-productos">
                        </tbody>
                     </table>
                  </div>
               </div>
               <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                  <button type="button" class="btn btn-primary"><i class="ti ti-printer me-1"></i> Imprimir</button>
               </div>
            </div>
         </div>
      </div>

      <div class="modal fade" id="modalRegistrarCotizacion" tabindex="-1" aria-labelledby="modalCotizacionLabel"
         aria-hidden="true">
         <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
               <div class="modal-header">
                  <h5 class="modal-title" id="modalCotizacionLabel">Registrar Cotización</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
               </div>
               <form id="formRegistrarCotizacion">
                  <div class="modal-body">
                     <input type="hidden" id="cotizacion-pedido-id">
                     <div class="mb-3">
                        <label for="cotizacion-costo-total" class="form-label">Costo Total de Cotización (S/)</label>
                        <input type="number" class="form-control" id="cotizacion-costo-total" step="0.01" min="0"
                           placeholder="0.00" required>
                     </div>
                     <div class="mb-3">
                        <label for="cotizacion-fecha-entrega" class="form-label">Fecha de Entrega Esperada</label>
                        <input type="date" class="form-control" id="cotizacion-fecha-entrega" required>
                     </div>
                  </div>
                  <div class="modal-footer">
                     <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                     <button type="submit" class="btn btn-primary" id="btn-guardar-cotizacion"
                        onclick="guardarCotizacion()">Guardar
                        Cotización</button>
                  </div>
               </form>

            </div>
         </div>
      </div>

      <div class="modal fade" id="modalReciboParcial" tabindex="-1" aria-labelledby="modalReciboParcialLabel"
         aria-hidden="true">
         <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
               <div class="modal-header">
                  <h5 class="modal-title" id="modalReciboParcialLabel">Recibo Parcial</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
               </div>

               <div class="modal-body">

                  <div class="row mb-3">
                     <div class="col-md-8">
                        <strong>Proveedor:</strong>
                        <p id="rp-proveedor" class="mb-1 text-muted">Cargando...</p>

                        <strong>ID Pedido:</strong>
                        <p id="rp-id" class="mb-0 text-muted">Cargando...</p>
                     </div>

                     <div class="col-md-4 text-md-end">
                        <strong>Estado:</strong>
                        <p id="rp-estado" class="mb-1">Cargando...</p>

                        <strong>Total Cotización:</strong>
                        <h4 id="rp-total" class="mb-0 text-primary">Cargando...</h4>
                     </div>
                  </div>

                  <hr>
                  <h6 class="mb-3">Productos del pedido</h6>

                  <div class="table-responsive">
                     <table class="table table-sm">
                        <thead>
                           <tr>
                              <th>Producto</th>
                              <th>Cantidad</th>
                              <th>¿Recibido?</th>
                           </tr>
                        </thead>
                        <tbody id="rp-tabla-productos">
                        </tbody>
                     </table>
                  </div>

               </div>

               <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                  <button type="button" class="btn btn-primary" onclick="guardarReciboParcial()">
                     Guardar Cambios
                  </button>

               </div>

            </div>
         </div>
      </div>



   </div>
</div>


<script>
   document.addEventListener('DOMContentLoaded', () => {

      const API_PEDIDOS = '/api/pedidos-proveedor';
      const API_PROVEEDORES = '/api/proveedores';
      const API_PRODUCTOS = '/api/productos';

      const pedidosTbody = document.getElementById('pedidosTbody');
      const modalNuevoPedido = document.getElementById('modalNuevoPedido');
      const formNuevoPedido = document.getElementById('formNuevoPedido');
      const selectProveedor = document.getElementById('pedidoProveedor');
      const inputFechaEmision = document.getElementById('pedidoFecha');
      const btnGuardarPedido = document.getElementById('btnGuardarPedido');
      const productoSearchInput = document.getElementById('productoSearchInput');
      const productoSearchResults = document.getElementById('productoSearchResults');
      const tablaProductosPedido = document.getElementById('tablaProductosPedido');

      async function cargarPedidos() {
         try {
            const response = await fetch(API_PEDIDOS);
            if (!response.ok) throw new Error('Error al cargar pedidos');
            const pedidos = await response.json();

            pedidosTbody.innerHTML = '';
            pedidos.reverse();
            pedidos.forEach(pedido => {
               const tr = document.createElement('tr');
               tr.innerHTML = `
                    <td><h6 class="mb-0">${pedido.id || 'N/A'}</h6></td>
                    <td>${pedido.razonSocialProveedor || '(Sin Proveedor)'}</td>
                    <td>${formatFecha(pedido.fechaEmision)}</td>
                    <td>${formatFecha(pedido.fechaEntregaEsperada)}</td>
                    <td>${formatCurrency(pedido.costoCotizacion)}</td>
                    <td>${formatEstado(pedido.estado)}</td>
                    <td>${generarBotonesAccion(pedido.id, pedido.estado)}</td>
                `;
               pedidosTbody.appendChild(tr);
            });
         } catch (error) {
            console.error(error);
            Swal.fire('Error', 'No se pudieron cargar los pedidos.', 'error');
         }
      }
      async function cargarProveedores() {
         try {
            const response = await fetch(API_PROVEEDORES);
            if (!response.ok) throw new Error('Error al cargar proveedores');
            const proveedores = await response.json();

            selectProveedor.innerHTML = '<option value="" selected disabled>Seleccionar un proveedor...</option>';
            proveedores.forEach(p => {
               if (p.estado === 'ACTIVO') {
                  const option = document.createElement('option');
                  option.value = p.id;
                  option.textContent = p.razonSocial;
                  selectProveedor.appendChild(option);
               }
            });
         } catch (error) {
            console.error(error);
            selectProveedor.innerHTML = '<option value="" selected disabled>Error al cargar</option>';
         }
      }

      modalNuevoPedido.addEventListener('show.bs.modal', () => {
         formNuevoPedido.reset();
         tablaProductosPedido.innerHTML = '';
         productoSearchResults.innerHTML = '';
         inputFechaEmision.value = new Date().toISOString().split('T')[0];
         cargarProveedores();
      });


      productoSearchInput.addEventListener('input', debounce(async (e) => {
         const query = e.target.value.trim();
         if (query.length < 2) {
            productoSearchResults.innerHTML = '';
            return;
         }

         try {
            const response = await fetch(`${API_PRODUCTOS}/buscar?query=${query}`);
            if (!response.ok) throw new Error('Error en la búsqueda');
            const productos = await response.json();

            productoSearchResults.innerHTML = '';
            productos.forEach(producto => {
               const item = document.createElement('a');
               item.href = '#';
               item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';

               let imgHtml = '<div style="width: 40px; height: 40px; background-color: #eee; border-radius: 4px;"></div>';
               if (producto.imagenes) {
                  try {
                     const imagenes = JSON.parse(producto.imagenes);
                     if (imagenes.length > 0) {
                        imgHtml = `<img src="/uploads/productos/${imagenes[0]}" alt="${producto.nombre}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">`;
                     }
                  } catch (e) { }
               }

               item.innerHTML = `
                    <div class="d-flex align-items-center">
                        ${imgHtml}
                        <div class="ms-3">
                            <h6 class="mb-0">${producto.nombre}</h6>
                            <small class="text-muted">${producto.codigo || ''}</small>
                        </div>
                    </div>
                    <span class="badge bg-light text-dark">Stock: ${producto.stockActual || 0}</span>
                `;
               item.addEventListener('click', (e) => {
                  e.preventDefault();
                  agregarProductoATabla(producto);
                  productoSearchInput.value = '';
                  productoSearchResults.innerHTML = '';
               });
               productoSearchResults.appendChild(item);
            });
         } catch (error) {
            console.error(error);
            productoSearchResults.innerHTML = '<div class="list-group-item text-danger">Error al buscar</div>';
         }
      }, 300));

      function agregarProductoATabla(producto) {
         if (document.getElementById(`prod-${producto.idProducto}`)) {
            Swal.fire('Atención', 'El producto ya está en la lista.', 'warning');
            return;
         }

         const tr = document.createElement('tr');
         tr.id = `prod-${producto.idProducto}`;
         tr.dataset.id = producto.idProducto;

         tr.innerHTML = `
            <td>
                ${producto.nombre}
                <small class="d-block text-muted">${producto.codigo || ''}</small>
            </td>
            <td>${producto.stockActual || 0}</td>
            <td>
                <input type="number" class="form-control form-control-sm" value="1" min="0.01" step="0.01" data-field="cantidad" style="width: 80px;">
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-danger btn-remove-item">
                    <i class="ti ti-trash"></i>
                </button>
            </td>
        `;
         tablaProductosPedido.appendChild(tr);
      }

      tablaProductosPedido.addEventListener('input', (e) => {
         if (e.target.dataset.field === 'cantidad' || e.target.dataset.field === 'precioCosto') {
            const tr = e.target.closest('tr');
            const cantidad = parseFloat(tr.querySelector('[data-field="cantidad"]').value) || 0;
            const precio = parseFloat(tr.querySelector('[data-field="precioCosto"]').value) || 0;
            const subtotal = cantidad * precio;
            tr.querySelector('[data-field="subtotal"]').textContent = formatCurrency(subtotal);
         }
      });

      tablaProductosPedido.addEventListener('click', (e) => {
         if (e.target.closest('.btn-remove-item')) {
            e.target.closest('tr').remove();
         }
      });

      btnGuardarPedido.addEventListener('click', async () => {
         const idProveedor = selectProveedor.value;
         const fechaEmision = inputFechaEmision.value;
         const notas = document.getElementById('pedidoNotas').value;

         if (!idProveedor || !fechaEmision) {
            Swal.fire('Campos Incompletos', 'Debe seleccionar un Proveedor y una Fecha de Emisión.', 'warning');
            return;
         }

         const detalles = [];
         const filas = tablaProductosPedido.querySelectorAll('tr');
         filas.forEach(tr => {
            const detalle = {
               idProducto: parseInt(tr.dataset.id),
               cantidad: parseFloat(tr.querySelector('[data-field="cantidad"]').value) || 0,
            };
            if (detalle.cantidad > 0) {
               detalles.push(detalle);
            }
         });

         const request = {
            idProveedor: parseInt(idProveedor),
            fechaEmision: fechaEmision,
            fechaEntregaEsperada: null,
            notas: notas,
            costoCotizacion: null,
            detalles: detalles
         };

         try {
            btnGuardarPedido.disabled = true;
            btnGuardarPedido.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';

            const response = await fetch(API_PEDIDOS, {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify(request)
            });

            if (response.ok) {
               const nuevoPedido = await response.json();
               Swal.fire('¡Éxito!', `Pedido ${nuevoPedido.id}, se ha enviado un correo de notificación al proveedor para la cotización.`, 'success');
               bootstrap.Modal.getInstance(modalNuevoPedido).hide();
               cargarPedidos();
            } else {
               const errorMsg = await response.text();
               Swal.fire('Error', errorMsg, 'error');
            }
         } catch (error) {
            console.error(error);
            Swal.fire('Error', 'No se pudo conectar con el servidor.', 'error');
         } finally {
            btnGuardarPedido.disabled = false;
            btnGuardarPedido.innerHTML = 'Realizar Cotización';
         }
      });

      pedidosTbody.addEventListener('click', async (e) => {
         const btnCancelar = e.target.closest('.btn-cancelar');
         const btnConfirmar = e.target.closest('.btn-confirmar');
         const btnVerDetalle = e.target.closest('.btn-ver-detalle');
         const btnReciboParcial = e.target.closest('.btn-recibo-parcial');
         const btnAprobar = e.target.closest('.btn-aprobar');
         const btnCotizar = e.target.closest('.btn-cotizar');
         if (btnConfirmar) {
            const id = btnConfirmar.dataset.id;
            Swal.fire({
               title: '¿Confirmar Recepción?',
               text: `¿Estás seguro de que deseas marcar el pedido ${id} como RECIBIDO? Esta acción no se puede deshacer.`,
               icon: 'warning',
               showCancelButton: true,
               confirmButtonColor: '#28a745',
               cancelButtonColor: '#6c757d',
               confirmButtonText: 'Sí, confirmar',
               cancelButtonText: 'Cancelar'
            }).then(async (result) => {
               if (result.isConfirmed) {
                  await ejecutarAccionPedido(id, 'confirmar');
               }
            });
         }

         if (btnCancelar) {
            const id = btnCancelar.dataset.id;
            Swal.fire({
               title: '¿Cancelar Pedido?',
               text: `¿Estás seguro de que deseas CANCELAR el pedido ${id}?`,
               icon: 'error',
               showCancelButton: true,
               confirmButtonColor: '#dc3545',
               cancelButtonColor: '#6c757d',
               confirmButtonText: 'Sí, cancelar',
               cancelButtonText: 'No'
            }).then(async (result) => {
               if (result.isConfirmed) {
                  await ejecutarAccionPedido(id, 'cancelar');
               }
            });
         }
         if (btnReciboParcial) {
            const id = btnReciboParcial.dataset.id;
            abrirModalParcial(id);
         }
         if (btnVerDetalle) {
            e.preventDefault();
            const id = btnVerDetalle.dataset.id;
            abrirModalDetalle(id);
         }

         if (btnCotizar) {
            const id = btnCotizar.dataset.id;
            abrirModalCotizar(id);
         }

         if (btnAprobar) {
            const id = btnAprobar.dataset.id;
            Swal.fire({
               title: '¿Aprobar y Proceder Pedido?',
               text: `¿Estás seguro de que deseas aprobar y proceder con el pedido ${id}?`,
               icon: 'question',
               showCancelButton: true,
               confirmButtonColor: '#007bff',
               cancelButtonColor: '#6c757d',
               confirmButtonText: 'Sí, aprobar',
               cancelButtonText: 'Cancelar'
            }).then(async (result) => {
               if (result.isConfirmed) {
                  await ejecutarAccionPedido(id, 'aprobar');
               }
            });
         }
      });


      async function abrirModalCotizar(id) {
         const modalCotizacionEl = document.getElementById('modalRegistrarCotizacion');
         const modalCotizacion = new bootstrap.Modal(modalCotizacionEl);
         const inputPedidoId = document.getElementById('cotizacion-pedido-id');
         inputPedidoId.value = id;
         const today = new Date();
         const year = today.getFullYear();
         const month = String(today.getMonth() + 1).padStart(2, '0'); 
         const day = String(today.getDate()).padStart(2, '0');
         const minDate = `${year}-${month}-${day}`;
         const fechaInput = document.getElementById('cotizacion-fecha-entrega');
         fechaInput.setAttribute('min', minDate);
         fechaInput.value = "";
         modalCotizacion.show();
      }


      function getMensajeExito(accion) {
         switch (accion) {
            case 'cotizar':
               return 'La cotización ha sido registrada. El pedido está listo para aprobar.';
            case 'aprobar':
               return 'El pedido ha sido aprobado y marcado como Pendiente.';
            case 'recibo-parcial':
               return 'Se ha registrado un recibo parcial para este pedido.';
            case 'recibir-completo':
               return 'El pedido ha sido marcado como Recibido Completamente.';
            case 'cancelar':
               return 'El pedido ha sido cancelado.';
            default:
               return 'El estado del pedido ha sido actualizado.';
         }
      }

      window.guardarCotizacion = async function () {
         const id = document.getElementById("cotizacion-pedido-id").value;
         const costoTotal = parseFloat(document.getElementById("cotizacion-costo-total").value);
         const fechaEntrega = document.getElementById("cotizacion-fecha-entrega").value;
         if (isNaN(costoTotal) || costoTotal <= 0 || !fechaEntrega) {
            Swal.fire('Campos Incompletos', 'Debe ingresar un costo total válido y una fecha de entrega esperada.', 'warning');
            return;
         }
         try {
            const response = await fetch(`${API_PEDIDOS}/${id}/cotizar`, {
               method: "PUT",
               headers: { "Content-Type": "application/json" },
               body: JSON.stringify({
                  costoCotizacion: costoTotal,
                  fechaEntregaEsperada: fechaEntrega
               })
            });
            if (!response.ok) {
               throw new Error("No se pudo guardar la cotización");
            }
            Swal.fire('¡Éxito!', getMensajeExito('cotizar'), 'success');
            const modalElement = document.getElementById('modalRegistrarCotizacion');
            bootstrap.Modal.getInstance(modalElement).hide();
            cargarPedidos();
         } catch (error) {
            console.error(error);
            Swal.fire('Error', 'No se pudo guardar la cotización.', 'error');
         }
      }


      async function abrirModalParcial(id) {

         const modalReciboEl = document.getElementById('modalReciboParcial');
         const modalRecibo = new bootstrap.Modal(modalReciboEl);

         const rpId = document.getElementById('rp-id');
         const rpProveedor = document.getElementById('rp-proveedor');
         const rpEstado = document.getElementById('rp-estado');
         const rpTotal = document.getElementById('rp-total');
         const rpTablaProductos = document.getElementById('rp-tabla-productos');

         rpId.textContent = "Cargando...";
         rpProveedor.textContent = "Cargando...";
         rpEstado.innerHTML = '<span class="badge text-bg-secondary">Cargando...</span>';
         rpTotal.textContent = "Cargando...";
         rpTablaProductos.innerHTML = '<tr><td colspan="3" class="text-center">Cargando...</td></tr>';

         modalRecibo.show();

         try {
            const response = await fetch(`${API_PEDIDOS}/${id}`);
            if (!response.ok) {
               throw new Error("No se pudo obtener el pedido");
            }
            const pedido = await response.json();
            rpId.textContent = pedido.id;
            rpProveedor.textContent = pedido.razonSocialProveedor || '(Sin Proveedor)';
            rpEstado.innerHTML = formatEstado(pedido.estado);
            rpTotal.textContent = formatCurrency(pedido.costoCotizacion);
            rpTablaProductos.innerHTML = "";
            if (pedido.detalles && pedido.detalles.length > 0) {
               pedido.detalles.forEach(item => {
                  const tr = document.createElement("tr");
                  tr.innerHTML = `
                  <td>
                     ${item.nombreProducto}
                     <small class="d-block text-muted">${item.idProducto}</small>
                  </td>
                  <td>${item.cantidad}</td>
                  <td class="text-center">
                     <input 
                        type="checkbox" 
                        class="form-check-input recibo-checkbox"
                        data-id-detalle="${item.id}" 
                        ${item.recibido ? "checked" : ""}
                     >
                  </td>
               `;
                  rpTablaProductos.appendChild(tr);
               });
            } else {
               rpTablaProductos.innerHTML = `<tr><td colspan="3" class="text-center">No hay productos.</td></tr>`;
            }
         } catch (error) {
            console.error(error);
            rpProveedor.textContent = "Error al cargar";
            rpId.textContent = error.message;
         }
      }

      window.guardarReciboParcial = async function () {
         const checkboxes = document.querySelectorAll(".recibo-checkbox");
         const detallesActualizados = [];
         checkboxes.forEach(cb => {
            detallesActualizados.push({
               idDetalle: cb.dataset.idDetalle,
               recibido: cb.checked
            });
         });
         const pedidoId = document.getElementById("rp-id").textContent;

         console.log(JSON.stringify(detallesActualizados));
         try {
            const response = await fetch(`${API_PEDIDOS}/${pedidoId}/recibo-parcial`, {
               method: "PUT",
               headers: { "Content-Type": "application/json" },
               body: JSON.stringify(detallesActualizados)
            });
            if (!response.ok) {
               throw new Error("No se pudo guardar los cambios");
            }

         } catch (error) {
            console.error(error);
            alert("Error al guardar los cambios");
         }
         const modalElement = document.getElementById('modalReciboParcial');
         bootstrap.Modal.getInstance(modalElement).hide();
         cargarPedidos();
      }


      async function abrirModalDetalle(id) {
         const modalVistaPreviaEl = document.getElementById('modalVistaPrevia');
         const modalVistaPrevia = new bootstrap.Modal(modalVistaPreviaEl);
         const detalleId = document.getElementById('detalle-id');
         const detalleProveedor = document.getElementById('detalle-proveedor');
         const detalleEstado = document.getElementById('detalle-estado');
         const detalleTotal = document.getElementById('detalle-total');
         const detalleFechaEmision = document.getElementById('detalle-fecha-emision');
         const detalleFechaEsperada = document.getElementById('detalle-fecha-esperada');
         const detalleFechaCreacion = document.getElementById('detalle-fecha-creacion');
         const detalleNotas = document.getElementById('detalle-notas');
         const detalleTablaProductos = document.getElementById('detalle-tabla-productos');

         detalleId.textContent = 'Cargando...';
         detalleProveedor.textContent = 'Cargando...';
         detalleEstado.innerHTML = '<span class="badge text-bg-secondary">Cargando...</span>';
         detalleTotal.textContent = 'Cargando...';
         detalleFechaEmision.textContent = 'Cargando...';
         detalleFechaEsperada.textContent = 'Cargando...';
         detalleFechaCreacion.textContent = 'Cargando...';
         detalleNotas.textContent = 'Cargando...';
         detalleTablaProductos.innerHTML = '<tr><td colspan="4" class="text-center">Cargando...</td></tr>';

         modalVistaPrevia.show();

         try {
            const response = await fetch(`${API_PEDIDOS}/${id}`);
            if (!response.ok) {
               throw new Error('Pedido no encontrado o error del servidor');
            }
            const pedido = await response.json();
            detalleId.textContent = pedido.id || 'N/A';
            detalleProveedor.textContent = pedido.razonSocialProveedor || '(Sin Proveedor)';
            detalleEstado.innerHTML = formatEstado(pedido.estado);
            detalleTotal.textContent = formatCurrency(pedido.costoCotizacion);
            detalleFechaEmision.textContent = formatFecha(pedido.fechaEmision);
            detalleFechaEsperada.textContent = formatFecha(pedido.fechaEntregaEsperada);
            detalleFechaCreacion.textContent = formatTimestamp(pedido.createdAt);
            detalleNotas.textContent = pedido.notas || '(Sin notas)';
            detalleTablaProductos.innerHTML = '';
            if (pedido.detalles && pedido.detalles.length > 0) {
               pedido.detalles.forEach(item => {
                  const tr = document.createElement('tr');
                  tr.innerHTML = `
                            <td>
                                ${item.nombreProducto || 'Producto desconocido'}
                                <small class="d-block text-muted">${item.codigoProducto || ''}</small> 
                            </td>
                            <td>${item.cantidad}</td>
                            <td>${item.recibido == true ? 'Sí' : 'No'}</td>
                        `;
                  detalleTablaProductos.appendChild(tr);
               });
            } else {
               detalleTablaProductos.innerHTML = '<tr><td colspan="4" class="text-center">Este pedido no tiene productos.</td></tr>';
            }

         } catch (error) {
            console.error(error);
            detalleProveedor.textContent = 'Error al cargar los datos';
            detalleId.textContent = error.message;
         }
      }

      async function ejecutarAccionPedido(id, accion) {
         try {
            const response = await fetch(`${API_PEDIDOS}/${id}/${accion}`, {
               method: 'PUT'
            });

            if (response.ok) {
               const mensajeExito = getMensajeExito(accion);
               Swal.fire('¡Actualizado!', mensajeExito, 'success');
               cargarPedidos();
            } else {
               const errorMsg = await response.text();
               Swal.fire('Error', errorMsg, 'error');
            }
         } catch (error) {
            Swal.fire('Error', 'No se pudo conectar con el servidor.', 'error');
         }
      }

      function formatCurrency(value) {
         return new Intl.NumberFormat('es-PE', {
            style: 'currency',
            currency: 'PEN'
         }).format(value || 0);
      }

      function formatFecha(fecha) {
         if (!fecha) return '--';
         const [year, month, day] = fecha.split('-');
         return `${day}/${month}/${year}`;
      }
      function formatTimestamp(timestamp) {
         if (!timestamp) return '--';
         const date = new Date(timestamp);
         const day = String(date.getDate()).padStart(2, '0');
         const month = String(date.getMonth() + 1).padStart(2, '0');
         const year = date.getFullYear();
         const hours = String(date.getHours()).padStart(2, '0');
         const minutes = String(date.getMinutes()).padStart(2, '0');
         return `${day}/${month}/${year} ${hours}:${minutes}`;
      }

      function formatEstado(estado) {
         switch (estado) {
            case 'BORRADOR':
               return '<span class="badge text-bg-secondary">Borrador</span>';
            case 'COTIZADO':
               return '<span class="badge text-bg-primary">Cotizado</span>';
            case 'PENDIENTE':
               return '<span class="badge text-bg-info">Pendiente</span>';
            case 'PARTIALMENTE_RECIBIDO':
               return '<span class="badge text-bg-warning">Recibido Parcial</span>';
            case 'RECIBIDO':
               return '<span class="badge text-bg-success">Recibido</span>';
            case 'CANCELADO':
               return '<span class="badge text-bg-danger">Cancelado</span>';
            default:
               return `<span class="badge text-bg-dark">${estado || 'Desconocido'}</span>`;
         }
      }


      function generarBotonesAccion(id, estado) {
         let botones = `
        <a href="#!" class="avtar avtar-xs btn-link-secondary btn-ver-detalle" data-id="${id}" data-bs-toggle="tooltip" title="Ver Detalle">
            <i class="ti ti-eye f-20"></i>
        </a>
         `;
         if (estado === 'BORRADOR') {
            botones += `
            <a href="#!" class="avtar avtar-xs btn-link-info btn-cotizar" data-id="${id}" data-bs-toggle="tooltip" title="Registrar Cotización">
                <i class="ti ti-pencil f-20"></i>
            </a>
            
            <a href="#!" class="avtar avtar-xs btn-link-danger btn-cancelar" data-id="${id}" data-bs-toggle="tooltip" title="Cancelar Pedido">
                <i class="ti ti-x f-20"></i>
            </a>
        `;
         }
         else if (estado === 'COTIZADO') {
            botones += `
            <a href="#!" class="avtar avtar-xs btn-link-success btn-aprobar" data-id="${id}" data-bs-toggle="tooltip" title="Aprobar y Proceder Pedido">
                <i class="ti ti-check f-20"></i>
            </a>

            <a href="#!" class="avtar avtar-xs btn-link-danger btn-cancelar" data-id="${id}" data-bs-toggle="tooltip" title="Cancelar Pedido">
                <i class="ti ti-x f-20"></i>
            </a>
        `;
         }
         else if (estado === 'PENDIENTE' || estado === 'PARTIALMENTE_RECIBIDO') {
            botones += `
            <a href="#!" class="avtar avtar-xs btn-link-warning btn-recibo-parcial" data-id="${id}" data-bs-toggle="tooltip" title="Recibo Parcial">
                <i class="ti ti-slice f-20"></i>
            </a>

            <a href="#!" class="avtar avtar-xs btn-link-success btn-confirmar" data-id="${id}" data-bs-toggle="tooltip" title="Confirmar Recepción Completa">
                <i class="ti ti-checks f-20"></i>
            </a>

            <a href="#!" class="avtar avtar-xs btn-link-danger btn-cancelar" data-id="${id}" data-bs-toggle="tooltip" title="Cancelar Pedido">
                <i class="ti ti-x f-20"></i>
            </a>
        `;
         }
         return botones;
      }


      function activarEventosBotones() {
         document.querySelectorAll(".btn-confirmar").forEach(btn => {
            btn.addEventListener("click", function () {
               const id = this.getAttribute("data-id");
               ejecutarAccionPedido(id, "confirmar");
            });
         });
         document.querySelectorAll(".btn-cancelar").forEach(btn => {
            btn.addEventListener("click", function () {
               const id = this.getAttribute("data-id");
               ejecutarAccionPedido(id, "cancelar");
            });
         });
      }




      function debounce(func, delay) {
         let timeout;
         return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
         };
      }

      cargarPedidos();
   });
</script>