<div class="pc-container"
  th:replace="~{dashboard/layout :: layout(~{::content}, ${usuario}, 'Productos', '/dashboard/productos')}">
  <div class="pc-content" th:fragment="content">
    <!-- [ Main Content ] start -->
    <div class="page-header">
      <div class="page-block">
        <div class="row align-items-center">
          <div class="col-md-12">
            <ul class="breadcrumb">
              <li class="breadcrumb-item"><a href="/dashboard">Inicio</a></li>
              <li class="breadcrumb-item"><a href="javascript:void(0)">Productos</a></li>
              <li class="breadcrumb-item active" aria-current="page">Lista</li>
            </ul>
          </div>
          <div class="col-md-12">
            <div class="page-header-title">
              <h2 class="mb-0">Lista de productos</h2>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla de productos -->
    <div class="row">
      <div class="col-12">
        <div class="card table-card">
          <div class="card-header d-flex align-items-center justify-content-between">
            <h5 class="mb-0">Inventario de lubricantes</h5>
            <button type="button" class="btn btn-primary" id="btnNuevoProducto" data-bs-toggle="modal"
              data-bs-target="#modalProducto">
              <i class="ti ti-plus me-1"></i> Nuevo Producto
            </button>
          </div>

          <div class="card-body pt-3">
            <div class="table-responsive">
              <table class="table table-hover" id="tablaProductos">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Código</th>
                    <th>Marca</th>
                    <th>Categoría</th>
                    <th>Unidad</th>
                    <th>Precio (S/)</th>
                    <th>Stock Mínimo</th>
                    <th>Estado</th>
                    <th>Acción</th>
                  </tr>
                </thead>
                <tbody id="tabla-productos-body">
                  <tr>
                    <td colspan="9" class="text-center">Cargando productos...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Producto -->
    <div class="modal fade" id="modalProducto" tabindex="-1" aria-labelledby="modalProductoLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalProductoLabel">Nuevo Producto</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>

          <div class="modal-body">
            <div id="alerta" class="alert d-none" role="alert"></div>
            <form id="formProducto">
              <input type="hidden" id="productoId">

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="codigo" class="form-label">Código</label>
                  <input type="text" class="form-control" id="codigo" required>
                  <div class="invalid-feedback" id="codigoError"></div>

                </div>
                <div class="col-md-6 mb-3">
                  <label for="nombre" class="form-label">Nombre</label>
                  <input type="text" class="form-control" id="nombre" required>
                  <div class="invalid-feedback" id="nombreError"></div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="marca" class="form-label">Marca</label>
                  <select class="form-select" id="marca" required></select>
                  <div class="invalid-feedback" id="marcaError"></div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="categoria" class="form-label">Categoría</label>
                  <select class="form-select" id="categoria" required></select>
                  <div class="invalid-feedback" id="categoriaError"></div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="precio" class="form-label">Precio (S/)</label>
                  <input type="number" class="form-control" id="precio" step="0.01">
                  <div class="invalid-feedback" id="precioError"></div>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="unidad" class="form-label">Unidad</label>
                  <input type="text" class="form-control" id="unidad" placeholder="Ej: Litro">
                  <div class="invalid-feedback" id="unidadError"></div>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="stockMinimo" class="form-label">Stock Mínimo</label>
                  <input type="number" class="form-control" id="stockMinimo" value="0">
                  <div class="invalid-feedback" id="stockMinimoError"></div>
                </div>
              </div>
            </form>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="btnGuardar">Guardar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- [ Main Content ] end -->
  </div>
</div>

<script>

  const urlBase = '/api/productos';
  let modalInstancia; 


  const modalEl = document.getElementById('modalProducto');
  const modalForm = document.getElementById("formProducto");
  const modalLabel = document.getElementById("modalProductoLabel");
  const modalAlerta = document.getElementById("alerta");
  const btnGuardar = document.getElementById("btnGuardar");
  const btnNuevoProducto = document.getElementById("btnNuevoProducto");
  const tablaCuerpo = document.getElementById("tabla-productos-body");
  const selMarca = document.getElementById("marca");
  const selCategoria = document.getElementById("categoria");



  function mostrarError(idCampo, mensaje) {
    const campo = document.getElementById(idCampo);
    const errorDiv = document.getElementById(idCampo + "Error");
    if (campo && errorDiv) {
      campo.classList.add("is-invalid");
      errorDiv.textContent = mensaje;
      errorDiv.style.display = "block";
    }
  }

  function limpiarErrores() {
    document.querySelectorAll(".is-invalid").forEach(el => el.classList.remove("is-invalid"));
    document.querySelectorAll(".invalid-feedback").forEach(el => el.style.display = "none");
    modalAlerta.classList.add("d-none"); 
  }

  function validarFormulario() {
    limpiarErrores();
    let valido = true;

    const codigo = document.getElementById("codigo").value.trim();
    const nombre = document.getElementById("nombre").value.trim();
    const marca = document.getElementById("marca").value;
    const categoria = document.getElementById("categoria").value;
    const precio = parseFloat(document.getElementById("precio").value);
    const unidad = document.getElementById("unidad").value.trim();
    const stockMinimo = parseFloat(document.getElementById("stockMinimo").value);

    const regexCodigo = /^[0-9]{8,13}$/;
    if (!regexCodigo.test(codigo)) {
      mostrarError("codigo", "El código debe tener entre 8 y 13 dígitos numéricos.");
      valido = false;
    }

    if (nombre.length < 4) {
      mostrarError("nombre", "El nombre debe tener al menos 4 caracteres.");
      valido = false;
    }

    if (!marca) {
      mostrarError("marca", "Seleccione una marca válida.");
      valido = false;
    }

    if (!categoria) {
      mostrarError("categoria", "Seleccione una categoría válida.");
      valido = false;
    }

    if (isNaN(precio) || precio <= 0) {
      mostrarError("precio", "El precio debe ser mayor que 0.");
      valido = false;
    }

    if (unidad.length === 0) {
      mostrarError("unidad", "Ingrese la unidad de medida.");
      valido = false;
    }

    if (isNaN(stockMinimo) || stockMinimo < 0) {
      mostrarError("stockMinimo", "El stock mínimo no puede ser negativo.");
      valido = false;
    }

    return valido;
  }

  function mostrarAlerta(msg, tipo) {
    modalAlerta.className = `alert alert-${tipo}`;
    modalAlerta.textContent = msg;
    modalAlerta.classList.remove("d-none");
  }



  async function listarProductos() {
    tablaCuerpo.innerHTML = `<tr><td colspan="9" class="text-center">Cargando...</td></tr>`;
    try {
      const resp = await fetch(urlBase);
      const productos = await resp.json();
      if (productos.length === 0) {
        tablaCuerpo.innerHTML = `<tr><td colspan="9" class="text-center">No hay productos registrados.</td></tr>`;
        return;
      }
      tablaCuerpo.innerHTML = productos.map(p => `
        <tr>
          <td>${p.nombre}</td>
          <td>${p.codigo}</td>
          <td>${p.marca?.nombre ?? '-'}</td>
          <td>${p.categoria?.nombre ?? '-'}</td>
          <td>${p.unidad ?? '-'}</td>
          <td>${p.precio?.toFixed(2) ?? '0.00'}</td>
          <td>${p.stockMinimo ?? 0}</td>
          <td>${p.estado ?? 'ACTIVO'}</td>
          <td>
            <button class="btn btn-sm btn-warning me-1" onclick='editarProducto(${JSON.stringify(p)})'>
              <i class="ti ti-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="eliminarProducto(${p.idProducto})">
              <i class="ti ti-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
    } catch (err) {
      tablaCuerpo.innerHTML = `<tr><td colspan="9" class="text-center text-danger">Error al cargar productos</td></tr>`;
    }
  }

  async function cargarMarcasYCategorias() {
    selMarca.innerHTML = `<option disabled selected>Cargando...</option>`;
    selCategoria.innerHTML = `<option disabled selected>Cargando...</option>`;
    try {
      const [marcasResp, categoriasResp] = await Promise.all([
        fetch('/api/marcas'),
        fetch('/api/categorias')
      ]);

      const marcas = await marcasResp.json();
      const categorias = await categoriasResp.json();

      selMarca.innerHTML = `<option value="" disabled selected>Seleccionar...</option>` + marcas.map(m => `<option value="${m.id}">${m.nombre}</option>`).join('');
      selCategoria.innerHTML = `<option value="" disabled selected>Seleccionar...</option>` + categorias.map(c => `<option value="${c.idCategoria}">${c.nombre}</option>`).join('');

    } catch (error) {
      console.error("Error cargando selects:", error);
      selMarca.innerHTML = `<option value="" disabled>Error al cargar</option>`;
      selCategoria.innerHTML = `<option value="" disabled>Error al cargar</option>`;
    }
  }

  function abrirModalNuevo() {
    modalForm.reset();
    document.getElementById("productoId").value = "";
    modalLabel.innerText = "Nuevo Producto";
    btnGuardar.innerText = "Guardar";
    limpiarErrores();
  }

  
  window.editarProducto = (p) => {
    abrirModalNuevo(); 

    document.getElementById("productoId").value = p.idProducto;
    document.getElementById("codigo").value = p.codigo;
    document.getElementById("nombre").value = p.nombre;
    document.getElementById("marca").value = p.marca?.id;
    document.getElementById("categoria").value = p.categoria?.idCategoria;
    document.getElementById("precio").value = p.precio;
    document.getElementById("unidad").value = p.unidad;
    document.getElementById("stockMinimo").value = p.stockMinimo ?? 0;

    modalLabel.innerText = "Editar Producto";
    btnGuardar.innerText = "Actualizar";
    modalInstancia.show();
  }

  window.eliminarProducto = async (id) => { 
    if (!confirm("¿Seguro de eliminar este producto?")) return;
    try {
      const resp = await fetch(`${urlBase}/${id}`, { method: "DELETE" });
      if (!resp.ok) throw new Error("No se pudo eliminar el producto");
      await listarProductos();
    } catch (err) {
      alert(`Error al eliminar: ${err.message}`);
    }
  }

  async function guardarProducto() {

    if (!validarFormulario()) {
      console.warn("Validación fallida.");
      mostrarAlerta("Por favor, corrija los errores marcados en rojo.", "warning");
      return;
    }

    console.log("Validación correcta. Enviando al backend...");

    const id = document.getElementById("productoId").value;
    const metodo = id ? "PUT" : "POST";
    const url = id ? `${urlBase}/${id}` : urlBase;

    const body = {
      codigo: document.getElementById("codigo").value.trim(),
      nombre: document.getElementById("nombre").value.trim(),
      idMarca: parseInt(document.getElementById("marca").value),
      idCategoria: parseInt(document.getElementById("categoria").value),
      precio: parseFloat(document.getElementById("precio").value),
      unidad: document.getElementById("unidad").value.trim(),
      idImpuesto: 1, 
      stockMinimo: parseInt(document.getElementById("stockMinimo").value),
      estado: "ACTIVO" 
    };

    try {
      const resp = await fetch(url, {
        method: metodo,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (!resp.ok) throw new Error(await resp.text());

      await listarProductos();
      modalInstancia.hide();

    } catch (err) {
      mostrarAlerta(`Error al guardar: ${err.message}`, "danger");
    }
  }


  document.addEventListener("DOMContentLoaded", async () => {
    modalInstancia = new bootstrap.Modal(modalEl);

    btnNuevoProducto.addEventListener("click", abrirModalNuevo);
    btnGuardar.addEventListener("click", guardarProducto);

    await cargarMarcasYCategorias();
    await listarProductos();
  });
</script>