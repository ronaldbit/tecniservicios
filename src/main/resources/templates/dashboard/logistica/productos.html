<div class="pc-container"
  th:replace="~{dashboard/layout :: layout(~{::content}, ${usuario}, 'Productos', '/dashboard/productos')}">
  <div class="pc-content" th:fragment="content">
    <!-- [ Main Content ] start -->
    <div class="page-header">
      <div class="page-block">
        <div class="row align-items-center">
          <div class="col-md-12">
            <ul class="breadcrumb">
              <li class="breadcrumb-item"><a href="/dashboard">Inicio</a></li>
              <li class="breadcrumb-item"><a href="javascript:void(0)">Productos</a></li>
              <li class="breadcrumb-item active" aria-current="page">Lista</li>
            </ul>
          </div>
          <div class="col-md-12">
            <div class="page-header-title">
              <h2 class="mb-0">Lista de productos</h2>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla de productos -->
    <div class="row">
      <div class="col-12">
        <div class="card table-card">
          <div class="card-header d-flex align-items-center justify-content-between">
            <h5 class="mb-0">Inventario de lubricantes</h5>

            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModalLive"
              onclick="LimpiarModal()">
              <i class="ti ti-plus me-1"></i> Actualizar Inventario
            </button>

            <button type="button" class="btn btn-primary" id="btnNuevoProducto" data-bs-toggle="modal"
              data-bs-target="#modalProducto">
              <i class="ti ti-plus me-1"></i> Nuevo Producto
            </button>
          </div>


          <div class="card-body pt-3">
            <div class="table-responsive">
              <table class="table table-hover" id="tablaProductos">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Código</th>
                    <th>Marca</th>
                    <th>Categoría</th>
                    <th>Unidad</th>
                    <th>Precio (S/)</th>
                    <th>Stock Mínimo</th>
                    <th>Stock Actual</th>
                    <th>Estado</th>
                    <th>Acción</th>
                  </tr>
                </thead>
                <tbody id="tabla-productos-body">
                  <tr>
                    <td colspan="9" class="text-center">Cargando productos...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Producto -->
    <div class="modal fade" id="modalProducto" tabindex="-1" aria-labelledby="modalProductoLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalProductoLabel">Nuevo Producto</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>

          <div class="modal-body">
            <div id="alerta" class="alert d-none" role="alert"></div>
            <form id="formProducto">
              <input type="hidden" id="productoId">

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="codigo" class="form-label">Código</label>
                  <input type="text" class="form-control" id="codigo" required>
                  <div class="invalid-feedback" id="codigoError"></div>

                </div>
                <div class="col-md-6 mb-3">
                  <label for="nombre" class="form-label">Nombre</label>
                  <input type="text" class="form-control" id="nombre" required>
                  <div class="invalid-feedback" id="nombreError"></div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="marca" class="form-label">Marca</label>
                  <select class="form-select" id="marca" required></select>
                  <div class="invalid-feedback" id="marcaError"></div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="categoria" class="form-label">Categoría</label>
                  <select class="form-select" id="categoria" required></select>
                  <div class="invalid-feedback" id="categoriaError"></div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="precio" class="form-label">Precio (S/)</label>
                  <input type="number" class="form-control" id="precio" step="0.01">
                  <div class="invalid-feedback" id="precioError"></div>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="unidad" class="form-label">Unidad</label>
                  <select class="form-control" id="unidad">
                    <option value="" selected disabled>Seleccione una unidad</option>
                    <option value="Litro">Litro</option>
                    <option value="Galón">Galón</option>
                    <option value="Mililitro">Mililitro</option>
                    <option value="Caja">Caja</option>
                    <option value="Envase">Envase</option>
                    <option value="Bidón">Bidón</option>
                    <option value="Unidad">Unidad</option>
                  </select>
                  <div class="invalid-feedback" id="unidadError"></div>
                </div>

                <div class="col-md-4 mb-3">
                  <label for="stockMinimo" class="form-label">Stock Mínimo</label>
                  <input type="number" class="form-control" id="stockMinimo" value="0">
                  <div class="invalid-feedback" id="stockMinimoError"></div>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="stockActual" class="form-label" id="StockActualLabel">Stock inicial (Opcional)</label>
                  <input type="number" class="form-control" id="stockActual" value="0">
                  <div class="invalid-feedback" id="stockActualError"></div>
                </div>

              </div>
            </form>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="btnGuardar">Guardar</button>
          </div>
        </div>
      </div>
    </div>

    <div id="exampleModalLive" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalLiveLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLiveLabel">Actualizar Inventario de Producto
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-5" style="border-right: 1px solid #ddd;">
                <div class="mb-3">
                  <label for="buscarProducto" class="form-label">1. Buscar Producto</label>
                  <input type="text" class="form-control" id="buscarProducto" placeholder="Buscar por SKU o Nombre...">
                </div>

                <div class="list-group" style="max-height: 400px; overflow-y: auto;">
                </div>
              </div>

              <div class="col-md-7">
                <h6 class="mb-3">Actualizar Inventario</h6>
                <div id="mensajeInventario" class="alert d-none mt-2" role="alert"></div>
                <form id="formActualizarInventario">
                  <div class="mb-3">
                    <label for="modoInventario" class="form-label">Modo de Actualización</label>
                    <select class="form-select" id="modoInventario" required>
                      <option value="" selected disabled>Seleccione una opción</option>
                      <option value="AUMENTAR">Aumentar Stock</option>
                      <option value="QUITAR">Quitar Stock</option>
                    </select>
                    <small class="form-text text-muted">
                      Selecciona si deseas aumentar o disminuir el stock disponible.
                    </small>
                  </div>

                  <div class="mb-3">
                    <label for="cantidadInventario" class="form-label">Cantidad</label>
                    <input type="number" class="form-control" id="cantidadInventario" min="1" placeholder="Ej. 10"
                      required>
                    <small class="form-text text-muted">
                      Ingresa la cantidad que deseas añadir o retirar del inventario.
                    </small>
                  </div>


                </form>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
              onclick="LimpiarModal()">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="ActualizarInventario()">Actualizar
              Inventario</button>

          </div>

        </div>
      </div>
    </div>
    <!-- [ Main Content ] end -->
  </div>
</div>

<script>

  const formValidationsOff = document.getElementById("formProducto");
  formValidationsOff.setAttribute('autocomplete', 'off');

  const urlBase = '/api/productos';
  let modalInstancia;


  const modalEl = document.getElementById('modalProducto');
  const modalForm = document.getElementById("formProducto");
  const modalLabel = document.getElementById("modalProductoLabel");
  const modalAlerta = document.getElementById("alerta");
  const btnGuardar = document.getElementById("btnGuardar");
  const btnNuevoProducto = document.getElementById("btnNuevoProducto");
  const tablaCuerpo = document.getElementById("tabla-productos-body");
  const selMarca = document.getElementById("marca");
  const selCategoria = document.getElementById("categoria");



  function mostrarError(idCampo, mensaje) {
    const campo = document.getElementById(idCampo);
    const errorDiv = document.getElementById(idCampo + "Error");
    if (campo && errorDiv) {
      campo.classList.add("is-invalid");
      errorDiv.textContent = mensaje;
      errorDiv.style.display = "block";
    }
  }

  function limpiarErrores() {
    document.querySelectorAll(".is-invalid").forEach(el => el.classList.remove("is-invalid"));
    document.querySelectorAll(".invalid-feedback").forEach(el => el.style.display = "none");
    modalAlerta.classList.add("d-none");
  }

  function validarFormulario() {
    limpiarErrores();
    let valido = true;

    const codigo = document.getElementById("codigo").value.trim();
    const nombre = document.getElementById("nombre").value.trim();
    const marca = document.getElementById("marca").value;
    const categoria = document.getElementById("categoria").value;
    const precio = parseFloat(document.getElementById("precio").value);
    const unidad = document.getElementById("unidad").value.trim();
    const stockMinimo = parseFloat(document.getElementById("stockMinimo").value);

    const regexCodigo = /^[0-9]{8,13}$/;
    if (!regexCodigo.test(codigo)) {
      mostrarError("codigo", "El código debe tener entre 8 y 13 dígitos numéricos.");
      valido = false;
    }

    if (nombre.length < 4) {
      mostrarError("nombre", "El nombre debe tener al menos 4 caracteres.");
      valido = false;
    }

    if (!marca) {
      mostrarError("marca", "Seleccione una marca válida.");
      valido = false;
    }

    if (!categoria) {
      mostrarError("categoria", "Seleccione una categoría válida.");
      valido = false;
    }

    if (isNaN(precio) || precio <= 0) {
      mostrarError("precio", "El precio debe ser mayor que 0.");
      valido = false;
    }

    if (unidad.length === 0) {
      mostrarError("unidad", "Ingrese la unidad de medida.");
      valido = false;
    }

    if (isNaN(stockMinimo) || stockMinimo < 0) {
      mostrarError("stockMinimo", "El stock mínimo no puede ser negativo.");
      valido = false;
    }

    return valido;
  }

  function mostrarAlerta(msg, tipo) {
    modalAlerta.className = `alert alert-${tipo}`;
    modalAlerta.textContent = msg;
    modalAlerta.classList.remove("d-none");
  }



  async function listarProductos() {
    tablaCuerpo.innerHTML = `<tr><td colspan="9" class="text-center">Cargando...</td></tr>`;
    try {
      const resp = await fetch(urlBase);
      const productos = await resp.json();
      if (productos.length === 0) {
        tablaCuerpo.innerHTML = `<tr><td colspan="9" class="text-center">No hay productos registrados.</td></tr>`;
        return;
      }
      tablaCuerpo.innerHTML = productos.map(p => `
        <tr>
          <td>${p.nombre}</td>
          <td>${p.codigo}</td>
          <td>${p.marca?.nombre ?? '-'}</td>
          <td>${p.categoria?.nombre ?? '-'}</td>
          <td>${p.unidad ?? '-'}</td>
          <td>${p.precio?.toFixed(2) ?? '0.00'}</td>
          <td>${p.stockMinimo ?? 0}</td>
          <td>${p.stockActual ?? 0}</td>
          <td>${p.estado ?? 'ACTIVO'}</td>
        <td>
            <button class="btn btn-sm btn-warning me-1" onclick='editarProducto(${JSON.stringify(p)})'>
              <i class="ti ti-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="eliminarProducto(${p.idProducto})">
              <i class="ti ti-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
    } catch (err) {
      tablaCuerpo.innerHTML = `<tr><td colspan="9" class="text-center text-danger">Error al cargar productos</td></tr>`;
    }
  }

  async function cargarMarcasYCategorias() {
    selMarca.innerHTML = `<option disabled selected>Cargando...</option>`;
    selCategoria.innerHTML = `<option disabled selected>Cargando...</option>`;
    try {
      const [marcasResp, categoriasResp] = await Promise.all([
        fetch('/api/marcas'),
        fetch('/api/categorias')
      ]);

      const marcas = await marcasResp.json();
      const categorias = await categoriasResp.json();

      selMarca.innerHTML = `<option value="" disabled selected>Seleccionar...</option>` + marcas.map(m => `<option value="${m.id}">${m.nombre}</option>`).join('');
      selCategoria.innerHTML = `<option value="" disabled selected>Seleccionar...</option>` + categorias.map(c => `<option value="${c.idCategoria}">${c.nombre}</option>`).join('');

    } catch (error) {
      console.error("Error cargando selects:", error);
      selMarca.innerHTML = `<option value="" disabled>Error al cargar</option>`;
      selCategoria.innerHTML = `<option value="" disabled>Error al cargar</option>`;
    }
  }

  function abrirModalNuevo() {
    modalForm.reset();
    document.getElementById("stockActual").value = "0";
    document.getElementById("stockActual").style.display = "block";
    document.getElementById("StockActualLabel").style.display = "block";
    document.getElementById("productoId").value = "";
    modalLabel.innerText = "Nuevo Producto";
    btnGuardar.innerText = "Guardar";
    limpiarErrores();
  }


  window.editarProducto = (p) => {
    abrirModalNuevo();
    document.getElementById("productoId").value = p.idProducto;
    document.getElementById("codigo").value = p.codigo;
    document.getElementById("nombre").value = p.nombre;
    document.getElementById("marca").value = p.marca?.id;
    document.getElementById("categoria").value = p.categoria?.idCategoria;
    document.getElementById("precio").value = p.precio;
    document.getElementById("unidad").value = p.unidad;
    document.getElementById("stockMinimo").value = p.stockMinimo ?? 0;
    document.getElementById("stockActual").style.display = "none";
    document.getElementById("StockActualLabel").style.display = "none";
    document.getElementById("stockActual").value = p.stockActual ?? 0;
    modalLabel.innerText = "Editar Producto";
    btnGuardar.innerText = "Actualizar";
    modalInstancia.show();
  }

  window.eliminarProducto = async (id) => {
    if (!confirm("¿Seguro de eliminar este producto?")) return;
    try {
      const resp = await fetch(`${urlBase}/${id}`, { method: "DELETE" });
      if (!resp.ok) throw new Error("No se pudo eliminar el producto");
      await listarProductos();
    } catch (err) {
      alert(`Error al eliminar: ${err.message}`);
    }
  }

  async function guardarProducto() {

    if (!validarFormulario()) {
      console.warn("Validación fallida.");
      mostrarAlerta("Por favor, corrija los errores marcados en rojo.", "warning");
      return;
    }

    console.log("Validación correcta. Enviando al backend...");

    const id = document.getElementById("productoId").value;
    const metodo = id ? "PUT" : "POST";
    const url = id ? `${urlBase}/${id}` : urlBase;

    const body = {
      codigo: document.getElementById("codigo").value.trim(),
      nombre: document.getElementById("nombre").value.trim(),
      idMarca: parseInt(document.getElementById("marca").value),
      idCategoria: parseInt(document.getElementById("categoria").value),
      precio: parseFloat(document.getElementById("precio").value),
      unidad: document.getElementById("unidad").value.trim(),
      idImpuesto: 1,
      stockMinimo: parseInt(document.getElementById("stockMinimo").value),
      stockActual: parseInt(document.getElementById("stockActual").value),
      estado: "ACTIVO"
    };

    try {
      const resp = await fetch(url, {
        method: metodo,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (!resp.ok) throw new Error(await resp.text());

      await listarProductos();
      modalInstancia.hide();

    } catch (err) {
      mostrarAlerta(`Error al guardar: ${err.message}`, "danger");
    }
  }


  document.addEventListener("DOMContentLoaded", async () => {
    modalInstancia = new bootstrap.Modal(modalEl);

    btnNuevoProducto.addEventListener("click", abrirModalNuevo);
    btnGuardar.addEventListener("click", guardarProducto);

    await cargarMarcasYCategorias();
    await listarProductos();
  });


  let productoSeleccionado = null;
  const buscarInput = document.getElementById("buscarProducto");
  const listaProductos = document.querySelector(".list-group");
  const mensajeInventario = document.getElementById("mensajeInventario");
  let debounceTimeout;

  function mostrarMensaje(texto, tipo = "success") {
    mensajeInventario.textContent = texto;
    mensajeInventario.className = `alert alert-${tipo} mt-2`;
    mensajeInventario.classList.remove("d-none");

    setTimeout(() => mensajeInventario.classList.add("d-none"), 4000);
  }

  function seleccionarProducto(id, nombre, codigo) {
    productoSeleccionado = { id, nombre, codigo };
    buscarInput.value = `${nombre} (${codigo})`;
    listaProductos.innerHTML = `
    <p class="text-success px-3">Producto seleccionado: <strong>${nombre}</strong></p>
  `;
    mostrarMensaje(`Producto "${nombre}" seleccionado.`, "info");
  }

  buscarInput.addEventListener("input", () => {
    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(buscarProductos, 400);
  });

  async function buscarProductos() {
    const query = buscarInput.value.trim();
    if (query.length < 2) {
      listaProductos.innerHTML = `<p class="text-muted px-3">Escribe al menos 2 caracteres...</p>`;
      return;
    }

    function escapeHtml(text) {
      return String(text).replace(/[&<>"']/g, m => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;"
      }[m]));
    }

    listaProductos.innerHTML = `<p class="text-primary px-3">Buscando...</p>`;
    try {
      const response = await fetch(`/api/productos/buscar?query=${encodeURIComponent(query)}`);
      if (!response.ok) throw new Error("Error al obtener productos");
      const productos = await response.json();

      listaProductos.innerHTML = productos.length
        ? productos.map(p => `
        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center"
          onclick="seleccionarProducto(${p.idProducto}, '${escapeHtml(p.nombre)}', '${escapeHtml(p.codigo)}')">
          <img src="/assets/images/user/avatar-1.jpg" alt="Producto" class="img-fluid rounded me-3" style="width: 40px; height: 40px;">
          <div>
            <h6 class="mb-0">${p.nombre}</h6>
            <small class="text-muted d-block">SKU: ${p.codigo}</small>
          </div>
        </a>
      `).join("")
        : `<p class="text-muted px-3">No se encontraron productos.</p>`;
    } catch (err) {
      console.error(err);
      listaProductos.innerHTML = `<p class="text-danger px-3">Error al buscar productos.</p>`;
    }
  }

  async function ActualizarInventario() {
    const modo = document.getElementById("modoInventario").value;
    const cantidadInput = document.getElementById("cantidadInventario");
    const cantidad = parseFloat(cantidadInput.value);

    if (!productoSeleccionado) {
      mostrarMensaje("Por favor selecciona un producto.", "warning");
      return;
    }

    if (!modo) {
      mostrarMensaje("Selecciona un modo de operación (Entrada o Salida).", "warning");
      return;
    }

    if (isNaN(cantidad) || cantidad <= 0) {
      cantidadInput.classList.add("is-invalid");
      mostrarMensaje("La cantidad debe ser un número mayor a 0.", "danger");
      return;
    } else {
      cantidadInput.classList.remove("is-invalid");
    }

    try {
      const response = await fetch(`/api/productos/actualizarInventario`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          idProducto: productoSeleccionado.id,
          modo,
          cantidad,
        }),
      });

      const text = await response.text();

      if (!response.ok) {
        mostrarMensaje(text || "Error al actualizar inventario.", "danger");
        return;
      }

      mostrarMensaje("Inventario actualizado correctamente.", "success");
      LimpiarModal();
    } catch (error) {
      console.error(error);
      mostrarMensaje("Ocurrió un error inesperado al actualizar.", "danger");
    }
  }

  function LimpiarModal() {
    buscarInput.value = "";
    listaProductos.innerHTML = "";
    document.getElementById("modoInventario").value = "";
    document.getElementById("cantidadInventario").value = "";
    productoSeleccionado = null;
  }

</script>