<div class="pc-container" th:replace="~{dashboard/layout :: layout(~{::content}, ${usuario}, 'Inicio', '/dashboard')}">
  <div class="pc-content" th:fragment="content">
    <!-- [ breadcrumb ] start -->
    <div class="page-header">
      <div class="page-block">
        <div class="row align-items-center">
          <div class="col-md-12">
            <ul class="breadcrumb">
              <li class="breadcrumb-item">
                <a href="../dashboard/index../.html">Inicio</a>
              </li>
              <li class="breadcrumb-item">
                <a href="javascript:void(0)">Clientes</a>
              </li>
              <li class="breadcrumb-item" aria-current="page">Lista</li>
            </ul>
          </div>
          <div class="col-md-12">
            <div class="page-header-title">
              <h2 class="mb-0">Lista de clientes</h2>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- [ breadcrumb ] end -->
    <!-- [ Main Content ] start -->
    <div class="row">
      <div class="col-12">
        <div class="card table-card">   


          <div class="card-body pt-3">
            <div class="table-responsive">
              <table class="table table-hover" id="pc-dt-simple">
                <thead>
                  <tr>
                    <th>Cliente</th>
                    <th>Documento</th>
                    <th>Teléfono</th>
                    <th>Correo</th>
                    <th>Dirección</th>
                    <th>Rol</th>
                    <th>Estado (Acción)</th>
                    <th>Registro</th>
                   
                  </tr>
                </thead>
                <tbody id="tabla-clientes-body">
                  <tr>
                    <td colspan="9" class="text-center p-3">Cargando clientes...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- [ Main Content ] end -->
  </div>
</div>


<script>
  document.addEventListener("DOMContentLoaded", () => {
    cargarClientes();
  });
  async function cargarClientes() {
    const tbody = document.getElementById("tabla-clientes-body");
    
    try {
      const response = await fetch('/api/usuarios/clientes');
      
      if (!response.ok) throw new Error("Error al obtener datos");
      
      const clientes = await response.json();
      
      tbody.innerHTML = ""; 

      if (clientes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center">No hay clientes registrados.</td></tr>';
        return;
      }

      clientes.forEach(usuario => {
        const p = usuario.persona || {};
        const nombreCompleto = `${p.nombres || ''} ${p.apellidos || ''}`.trim() || usuario.nombreUsuario;
        const doc = p.numeroDocumento || 'S/N';
        const tel = p.telefono || '-';
        const email = p.email || usuario.nombreUsuario || '-'; 
        const dir = p.direccion || '-';
        const rol = usuario.roles && usuario.roles.length > 0 ? usuario.roles[0].nombre : 'Sin Rol';
        
        const fechaRegistro = usuario.fechaCreacion ? new Date(usuario.fechaCreacion).toLocaleDateString() : '-';

        const isActivo = usuario.estado === 'ACTIVO';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <img src="/assets/images/user/avatar-2.jpg" alt="cliente" class="img-radius wid-40"/>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="mb-0">${nombreCompleto}</h6>
                        <small class="text-muted d-block">${p.razonSocial || 'Persona Natural'}</small>
                    </div>
                </div>
            </td>
            <td>${doc}</td>
            <td>${tel}</td>
            <td>${email}</td>
            <td>${dir}</td>
            <td><span class="badge text-bg-info">${rol}</span></td>
            <td>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" 
                           id="switch-estado-${usuario.id}"
                           ${isActivo ? 'checked' : ''} 
                           onchange="cambiarEstadoUsuario(${usuario.id}, this)">
                    <label class="form-check-label" for="switch-estado-${usuario.id}">
                        ${isActivo ? 'Activo' : 'Inactivo'}
                    </label>
                </div>
            </td>
            <td>${fechaRegistro}</td>
    
        `;
        tbody.appendChild(tr);
      });

    } catch (error) {
      console.error(error);
      tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error cargando la lista de clientes.</td></tr>';
    }
  }

  async function cambiarEstadoUsuario(id, checkbox) {
    const estadoOriginal = !checkbox.checked;
    const label = checkbox.nextElementSibling; 
    checkbox.disabled = true;

    try {
        const response = await fetch(`/api/usuarios/${id}/CambiarEstado`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error("Error al cambiar estado en el servidor");
        }

        if (checkbox.checked) {
            label.textContent = "Activo";      
        } else {
            label.textContent = "Inactivo";
        }

    } catch (error) {
        console.error(error);
        alert("No se pudo cambiar el estado del usuario.");        
        checkbox.checked = estadoOriginal;
    } finally {
        checkbox.disabled = false;
    }
  }
</script>

<script>
  (function () {
    const $rows = document.querySelectorAll("#pc-dt-simple tbody tr");
    const tipo = document.getElementById("filtro-tipo");
    const estado = document.getElementById("filtro-estado");

    function filtrar() {
      const t = tipo.value;
      const e = estado.value;
      $rows.forEach((row) => {
        const okTipo = !t || row.getAttribute("data-tipo") === t;
        const okEstado = !e || row.getAttribute("data-estado") === e;
        row.style.display = okTipo && okEstado ? "" : "none";
      });
    }
    tipo?.addEventListener("change", filtrar);
    estado?.addEventListener("change", filtrar);
  })();
</script>
