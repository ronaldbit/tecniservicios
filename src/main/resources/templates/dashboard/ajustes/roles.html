<div
  class="pc-container"
  th:replace="~{dashboard/layout :: layout(~{::content}, ${usuario}, 'Inicio', '/dashboard')}"
>
  <div class="pc-content" th:fragment="content">
    <!-- Breadcrumb -->
    <div class="page-header">
      <div class="page-block">
        <div class="row align-items-center">
          <div class="col-md-12">
            <ul class="breadcrumb">
              <li class="breadcrumb-item">
                <a href="/dashboard">Home</a>
              </li>
              <li class="breadcrumb-item"><a href="">Roles</a></li>
              <li class="breadcrumb-item active" aria-current="page">Lista</li>
            </ul>
          </div>
          <div class="col-md-12">
            <div class="page-header-title">
              <h2 class="mb-0">Lista de roles en el sistema</h2>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla de usuarios -->
    <div class="row">
      <div class="col-12">
        <div class="card table-card">
          <div
            class="card-header d-flex justify-content-between align-items-center"
          >
            <h5>Lista de roles</h5>
            <button
              class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#modalAgregarRol"
            >
              <i class="ti ti-user-plus"></i> Agregar Rol
            </button>
          </div>
          <div class="card-body pt-3">
            <div class="table-responsive">
              <table class="table table-hover" id="pc-dt-simple">
                <thead>
                  <tr>
                    <th>Rol</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="r : ${roles}">
                    <td>
                      <span
                        class="badge text-bg-success"
                        th:text="${r.nombre}"
                      ></span>
                    </td>
                    <td>
                      <a
                        href="#"
                        class="avtar avtar-xs btn-link-secondary"
                        data-bs-toggle="modal"
                        th:attr="data-bs-target=${'#modalDetalleRol' + r.id}"
                        title="Ver detalles"
                      >
                        <i class="ti ti-eye f-20"></i>
                      </a>
                      <button
                        type="button"
                        class="avtar avtar-xs btn-link-secondary btn-editar-rol"
                        data-bs-toggle="modal"
                        data-bs-target="#modalAgregarRol"
                        th:attr="data-rol-id=${r.id}"
                        title="Editar rol"
                      >
                        <i class="ti ti-edit f-20"></i>
                      </button>

                      <button
                        type="button"
                        class="avtar avtar-xs btn-link-secondary btn-eliminar-rol"
                        data-bs-toggle="modal"
                        data-bs-target="#modalConfirmarEliminar"
                        th:attr="data-rol-id=${r.id}, data-rol-nombre=${r.nombre}"
                        title="Eliminar rol"
                      >
                        <i class="ti ti-trash f-20"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Agregar rol -->
    <div
      class="modal fade"
      id="modalAgregarRol"
      tabindex="-1"
      aria-labelledby="modalAgregarRolLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <form class="modal-content" id="formAgregarRol" novalidate>
          <input type="hidden" id="rolId" name="id" value="" />
          <div class="modal-header">
            <h5 class="modal-title" id="modalAgregarRolLabel">Agregar Rol</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <div
              id="serverError"
              class="alert alert-danger d-none"
              role="alert"
              style="margin: 0 1rem 1rem"
            ></div>
            <div class="mb-3">
              <label for="nombreRol" class="form-label">Nombre del Rol</label>
              <input
                type="text"
                class="form-control"
                id="nombreRol"
                name="nombre"
                placeholder="Ejemplo: Administrador"
                required
              />
              <div class="invalid-feedback">
                El nombre del rol es obligatorio.
              </div>
            </div>

            <div class="mb-3">
              <label for="descripcionRol" class="form-label">Descripción</label>
              <textarea
                class="form-control"
                id="descripcionRol"
                name="descripcion"
                placeholder="Describe brevemente el rol"
                rows="2"
                required
                minlength="5"
              ></textarea>
              <div class="invalid-feedback">
                La descripción debe tener al menos 5 caracteres.
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Permisos disponibles</label>

              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="permisoVentas"
                  name="Ventas"
                />
                <label class="form-check-label" for="permisoVentas">
                  Acceso a Ventas
                </label>
              </div>

              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="permisoLogistica"
                  name="Logistica"
                />
                <label class="form-check-label" for="permisoLogistica">
                  Acceso a Logística
                </label>
              </div>

              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="permisoReportes"
                  name="Reportes"
                />
                <label class="form-check-label" for="permisoReportes">
                  Acceso a Reportes
                </label>
              </div>

              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="permisoAjustes"
                  name="Ajustes"
                />
                <label class="form-check-label" for="permisoAjustes">
                  Acceso a Ajustes
                </label>
              </div>

              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="permisoNavegacion"
                  name="Navegacion"
                />
                <label class="form-check-label" for="permisoNavegacion">
                  Acceso a Navegación
                </label>
              </div>

              <div id="permisoError" class="text-danger mt-1 d-none">
                Debes seleccionar al menos un permiso.
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">Guardar Rol</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const API_URL = "/api/roles-permisos";

      // Función para resetear el formulario a modo "Agregar"
      function resetFormularioRol() {
        const form = document.getElementById("formAgregarRol");
        form.reset();
        form.classList.remove("was-validated");
        document.getElementById("rolId").value = ""; // Limpiar el ID
        document.getElementById("modalAgregarRolLabel").textContent =
          "Agregar Rol"; // Título
        document.getElementById("permisoError").classList.add("d-none");
        document
          .querySelectorAll('#formAgregarRol input[type="checkbox"]')
          .forEach((checkbox) => {
            checkbox.checked = false; // Desmarcar todos los permisos
          });
      }

      // Función principal de inicialización
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("formAgregarRol");
        const permisoError = document.getElementById("permisoError");

        // 1. Manejar la apertura del modal para LIMPIAR al agregar
        const modalElement = document.getElementById("modalAgregarRol");
        modalElement.addEventListener("hidden.bs.modal", resetFormularioRol); // Limpiar al cerrar

        // 2. Manejar el clic en los botones de EDICIÓN
        document.querySelectorAll(".btn-editar-rol").forEach((button) => {
          button.addEventListener("click", async (event) => {
            const rolId = event.currentTarget.getAttribute("data-rol-id");
            if (!rolId) return;

            // Cargar datos del rol (GET /Api/roles-permisos/{id})
            try {
              const response = await fetch(`${API_URL}/${rolId}`);
              if (!response.ok)
                throw new Error("Error al obtener datos del rol.");
              const rol = await response.json();

              // Rellenar el formulario
              document.getElementById("rolId").value = rol.id;
              document.getElementById("nombreRol").value = rol.nombre;
              document.getElementById("descripcionRol").value = rol.descripcion;
              document.getElementById("modalAgregarRolLabel").textContent =
                "Editar Rol: " + rol.nombre;

              // Rellenar los permisos (asumiendo que rol.permisos es una lista de objetos {nombre: "ventas"})
              const permisosAsignados = rol.permisos.map((p) =>
                p.nombre.toLowerCase()
              );
              document
                .querySelectorAll('#formAgregarRol input[type="checkbox"]')
                .forEach((checkbox) => {
                  const permisoName = checkbox.name.toLowerCase();
                  checkbox.checked = permisosAsignados.includes(permisoName);
                });
            } catch (error) {
              console.error("Error al cargar datos del rol:", error);
              alert("No se pudo cargar la información del rol para edición.");
            }
          });
        });
        form.addEventListener("submit", async (event) => {
          event.preventDefault();
          event.stopPropagation();
          permisoError.classList.add("d-none");
          let formValido = form.checkValidity();
          const nombre = document.getElementById("nombreRol");
          const descripcion = document.getElementById("descripcionRol");
          const rolId = document.getElementById("rolId").value;

          const permisosDisponibles = [
            {
              id: "permisoNavegacion",
              path: "/navegacion",
              nombre: "Navegacion",
            },
            { id: "permisoVentas", path: "/ventas", nombre: "Ventas" },
            { id: "permisoLogistica", path: "/logistica", nombre: "Logistica" },
            { id: "permisoReportes", path: "/reportes", nombre: "Reportes" },
            { id: "permisoAjustes", path: "/ajustes", nombre: "Ajustes" },

          ];
          const permisos = permisosDisponibles
            .filter((p) => document.getElementById(p.id).checked)
            .map((p) => ({
              path: p.path,
              nombre: p.nombre,
              rolId: rolId ? rolId : null,
            }));

          if (permisos.length === 0) {
            permisoError.classList.remove("d-none");
            formValido = false;
          }

          form.classList.add("was-validated");
          if (!formValido) {
            return;
          }

          const isEditing = !!rolId;
          const method = isEditing ? "PUT" : "POST";
          const url = isEditing ? `${API_URL}/${rolId}` : API_URL;

          const rolData = {
            ...(isEditing && { id: rolId }),
            nombre: nombre.value.trim(),
            descripcion: descripcion.value.trim(),
            permisos,
          };

          try {
            const response = await fetch(url, {
              method: method,
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(rolData),
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(
                errorText || "Error desconocido al procesar la solicitud."
              );
            }

            const data = await response.json();
            console.log("Respuesta del servidor:", data);
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("modalAgregarRol")
            );
            modal.hide();
            window.location.reload();
          } catch (error) {
            console.error("Error:", error);
            const serverErrorElement = document.getElementById("serverError");
            let displayMessage;
            if (error.message.includes("EL NOMBRE DE ROL YA ESTA EN USO")) {
              displayMessage =
                "El nombre de rol ya está en uso. Intenta con otro.";
            } else if (error.message.includes("Failed to fetch")) {
              displayMessage = "No se pudo conectar con el servidor.";
            } else {
              displayMessage = "Ocurrió un problema al procesar la solicitud.";
            }
            serverErrorElement.textContent = displayMessage;
            serverErrorElement.classList.remove("d-none");

            form.classList.add("was-validated");
          }
        });
      });

      document.addEventListener("DOMContentLoaded", () => {
        const modalEliminar = document.getElementById("modalConfirmarEliminar");
        const rolIdEliminarInput = document.getElementById("rolIdEliminar");
        const rolNombreEliminarSpan =
          document.getElementById("rolNombreEliminar");
        const btnConfirmarEliminar = document.getElementById(
          "btnConfirmarEliminar"
        );
        const deleteServerError = document.getElementById("deleteServerError");
        const API_URL = "/api/roles-permisos";

        document.querySelectorAll(".btn-eliminar-rol").forEach((button) => {
          button.addEventListener("click", (event) => {
            const rolId = event.currentTarget.getAttribute("data-rol-id");
            const rolNombre =
              event.currentTarget.getAttribute("data-rol-nombre");

            rolIdEliminarInput.value = rolId;
            rolNombreEliminarSpan.textContent = rolNombre;
            deleteServerError.classList.add("d-none");
          });
        });

        btnConfirmarEliminar.addEventListener("click", async () => {
          const idToDelete = rolIdEliminarInput.value;

          if (!idToDelete) {
            deleteServerError.textContent = "Error: ID de rol no encontrado.";
            deleteServerError.classList.remove("d-none");
            return;
          }

          try {
            const response = await fetch(`${API_URL}/${idToDelete}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
            });

            if (response.status === 204 || response.ok) {
              const modalInstance = bootstrap.Modal.getInstance(modalEliminar);
              modalInstance.hide();
              window.location.reload();
            } else {
              const errorText = await response.text();
              deleteServerError.textContent =
                errorText || "Error desconocido al eliminar el rol.";
              deleteServerError.classList.remove("d-none");
            }
          } catch (error) {
            console.error("Error de red al eliminar:", error);
            deleteServerError.textContent =
              "Error de conexión. Intenta de nuevo.";
            deleteServerError.classList.remove("d-none");
          }
        });
      });
    </script>

    <!-- Modales de detalle de rol -->
    <div th:each="r : ${roles}">
      <div
        class="modal fade"
        th:id="'modalDetalleRol' + ${r.id}"
        tabindex="-1"
        th:attr="aria-labelledby=${'modalDetalleRolLabel' + r.id}"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5
                class="modal-title"
                th:id="'modalDetalleRolLabel' + ${r.id}"
                th:text="'Detalles del Rol: ' + ${r.nombre}"
              ></h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Cerrar"
              ></button>
            </div>

            <div class="modal-body">
              <div class="mb-3">
                <strong>Nombre:</strong>
                <p th:text="${r.nombre}"></p>
              </div>

              <div class="mb-3">
                <strong>Descripción:</strong>
                <p th:text="${r.descripcion}"></p>
              </div>

              <div class="mb-3">
                <strong>Permisos:</strong>
                <ul>
                  <li th:each="p : ${r.permisos}" th:text="${p.nombre}"></li>
                  <li th:if="${#lists.isEmpty(r.permisos)}" class="text-muted">
                    Sin permisos asignados
                  </li>
                </ul>
              </div>
            </div>

            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cerrar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal Confirmar Eliminación -->
    <div
      class="modal fade"
      id="modalConfirmarEliminar"
      tabindex="-1"
      aria-labelledby="modalConfirmarEliminarLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalConfirmarEliminarLabel">
              Confirmar Eliminación
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              ¿Estás seguro de que deseas eliminar el rol
              <span id="rolNombreEliminar"></span>?
            </p>
            <div
              id="deleteServerError"
              class="alert alert-danger d-none mt-3"
              role="alert"
            ></div>
            <input type="hidden" id="rolIdEliminar" value="" />
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-danger"
              id="btnConfirmarEliminar"
            >
              Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
